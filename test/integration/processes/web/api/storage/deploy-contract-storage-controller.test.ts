import supertest from 'supertest';
import { WebProcess } from '../../../../../../src/processes/web/web-process';
import {
  postgreConfig,
  serverConfig,
  tezosNodeUrl,
} from '../../../../../__fixtures__/config';
import { TezosService } from '../../../../../../src/services/tezos';
import { SignerFactory } from '../../../../../../src/services/signer-factory';
import { FakeSigner } from '../../../../../../src/services/signers/fake-signer';
import { PostgreService } from '../../../../../../src/services/postgre';

describe('[processes/web/api/storage] Deploy Contract Controller', () => {
  const webProcess = new WebProcess({ server: serverConfig });
  const tezosService = new TezosService(tezosNodeUrl);
  const postgreService = new PostgreService(postgreConfig);
  const fakeSigner = new FakeSigner('pkh', '');
  const signerFactory = new SignerFactory();

  webProcess.postgreService = postgreService;

  const request: supertest.SuperTest<supertest.Test> = supertest(
    webProcess.app,
  );

  beforeAll(async () => {
    webProcess.signerFactory = signerFactory;
    await webProcess.start();
  });

  beforeEach(() => {
    jest
      .spyOn(webProcess.gatewayPool, 'getTezosService')
      .mockResolvedValue(tezosService);
  });

  afterEach(() => {
    jest.restoreAllMocks();
  });

  afterAll(async () => {
    await webProcess.stop();
  });

  describe('#compileAndDeployContract', () => {
    it('Should return 400 when secureKeyName has unexpected value and smartContractCode is correct', async () => {
      const { body, status } = await request
        .post('/api/tezos_node/contract/deploy')
        .set('Content-Type', 'application/json')
        .send({
          secureKeyName: 'nothing',
          smartContractCode:
            'aW1wb3J0IHNtYXJ0cHkgYXMgc3AKCmNsYXNzIENvdW50ZXIoc3AuQ29udHJhY3QpOgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBpbml0aWFsVmFsKToKICAgICAgICBzZWxmLmluaXQoCiAgICAgICAgICAgIHZhbHVlID0gaW5pdGlhbFZhbAogICAgICAgICkKCiAgICBkZWYgaW5jcmVtZW50KHNlbGYsIGFtb3VudCk6CiAgICAgICAgc2VsZi5kYXRhLnZhbHVlICs9IGFtb3VudAoKCiAgICBkZWYgZGVjcmVtZW50KHNlbGYsIGFtb3VudCk6CiAgICAgICAgc2VsZi5kYXRhLnZhbHVlIC09IGFtb3VudAoKCgpAc3AuYWRkX3Rlc3QobmFtZSA9ICJDb3VudGVyIikKZGVmIHRlc3QoKToKICAgIHNjZW5hcmlvID0gc3AudGVzdF9zY2VuYXJpbygpCgogICAgY291bnRlciA9IENvdW50ZXIoNSkKICAgIHNjZW5hcmlvICs9IGNvdW50ZXIKICAgIHNwLmFkZF9jb21waWxhdGlvbl90YXJnZXQoJ2NvdW50ZXIgdGFyZ2V0JywgQ291bnRlcigyKSkK',
        });

      expect(status).toEqual(404);
      expect(body).toEqual({
        message: 'Error while fetching public key with the key name: nothing',
        status: 404,
      });
    });

    it('Should return 200 when secureKeyName is correct and smartContractCode is correct', async () => {
      jest.spyOn(tezosService, 'deployContract').mockResolvedValue({
        operation_hash: 'operation_hash',
        contract_address: 'contract_address',
      });
      jest.spyOn(signerFactory, 'generateSigner').mockReturnValue(fakeSigner);

      const { body, status } = await request
        .post('/api/tezos_node/contract/deploy')
        .set('Content-Type', 'application/json')
        .send({
          secureKeyName: 'admin',
          smartContractCode:
            'aW1wb3J0IHNtYXJ0cHkgYXMgc3AKCmNsYXNzIENvdW50ZXIoc3AuQ29udHJhY3QpOgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBpbml0aWFsVmFsKToKICAgICAgICBzZWxmLmluaXQoCiAgICAgICAgICAgIHZhbHVlID0gaW5pdGlhbFZhbAogICAgICAgICkKCiAgICBkZWYgaW5jcmVtZW50KHNlbGYsIGFtb3VudCk6CiAgICAgICAgc2VsZi5kYXRhLnZhbHVlICs9IGFtb3VudAoKCiAgICBkZWYgZGVjcmVtZW50KHNlbGYsIGFtb3VudCk6CiAgICAgICAgc2VsZi5kYXRhLnZhbHVlIC09IGFtb3VudAoKCgpAc3AuYWRkX3Rlc3QobmFtZSA9ICJDb3VudGVyIikKZGVmIHRlc3QoKToKICAgIHNjZW5hcmlvID0gc3AudGVzdF9zY2VuYXJpbygpCgogICAgY291bnRlciA9IENvdW50ZXIoNSkKICAgIHNjZW5hcmlvICs9IGNvdW50ZXIKICAgIHNwLmFkZF9jb21waWxhdGlvbl90YXJnZXQoJ2NvdW50ZXIgdGFyZ2V0JywgQ291bnRlcigyKSkK',
        });

      expect(status).toEqual(201);
      expect(body).toEqual({
        operation_hash: 'operation_hash',
        contract_address: 'contract_address',
      });
    });

    it('Should return 200 when secureKeyName is correct and smartContractCode is correct and storage object is set', async () => {
      jest.spyOn(tezosService, 'deployContract').mockResolvedValue({
        operation_hash: 'operation_hash',
        contract_address: 'contract_address',
      });
      jest.spyOn(signerFactory, 'generateSigner').mockReturnValue(fakeSigner);

      const { body, status } = await request
        .post('/api/tezos_node/contract/deploy')
        .set('Content-Type', 'application/json')
        .send({
          secureKeyName: 'admin',
          smartContractCode:
            'IyMKIyMgIyMgSW50cm9kdWN0aW9uCiMjCiMjIFNlZSB0aGUgRkEyIHN0YW5kYXJkIGRlZmluaXRpb246CiMjIDxodHRwczovL2dpdGxhYi5jb20vdHppcC90emlwLy0vYmxvYi9tYXN0ZXIvcHJvcG9zYWxzL3R6aXAtMTIvPgojIwojIyBTZWUgbW9yZSBleGFtcGxlcy9kb2N1bWVudGF0aW9uIGF0CiMjIDxodHRwczovL2dpdGxhYi5jb20vc21vbmRldC9mYTItc21hcnRweS8+IGFuZAojIyA8aHR0cHM6Ly9hc3NldHMudHF0ZXpvcy5jb20vZG9jcy90b2tlbi1jb250cmFjdHMvZmEyLzEtZmEyLXNtYXJ0cHkvPi4KIyMKaW1wb3J0IHNtYXJ0cHkgYXMgc3AKIyMKIyMgIyMgTWV0YS1Qcm9ncmFtbWluZyBDb25maWd1cmF0aW9uCiMjCiMjIFRoZSBgRkEyX2NvbmZpZ2AgY2xhc3MgaG9sZHMgdGhlIG1ldGEtcHJvZ3JhbW1pbmcgY29uZmlndXJhdGlvbi4KIyMKY2xhc3MgRkEyX2NvbmZpZzoKICAgIGRlZiBfX2luaXRfXyhzZWxmLAogICAgICAgICAgICAgICAgIGRlYnVnX21vZGUgICAgICAgICAgICAgICAgICAgICAgICAgPSBGYWxzZSwKICAgICAgICAgICAgICAgICBzaW5nbGVfYXNzZXQgICAgICAgICAgICAgICAgICAgICAgID0gRmFsc2UsCiAgICAgICAgICAgICAgICAgbm9uX2Z1bmdpYmxlICAgICAgICAgICAgICAgICAgICAgICA9IFRydWUsCiAgICAgICAgICAgICAgICAgYWRkX211dGV6X3RyYW5zZmVyICAgICAgICAgICAgICAgICA9IEZhbHNlLAogICAgICAgICAgICAgICAgIHJlYWRhYmxlICAgICAgICAgICAgICAgICAgICAgICAgICAgPSBUcnVlLAogICAgICAgICAgICAgICAgIGZvcmNlX2xheW91dHMgICAgICAgICAgICAgICAgICAgICAgPSBUcnVlLAogICAgICAgICAgICAgICAgIHN1cHBvcnRfb3BlcmF0b3IgICAgICAgICAgICAgICAgICAgPSBUcnVlLAogICAgICAgICAgICAgICAgIGFzc3VtZV9jb25zZWN1dGl2ZV90b2tlbl9pZHMgICAgICAgPSBUcnVlLAogICAgICAgICAgICAgICAgIHN0b3JlX3RvdGFsX3N1cHBseSAgICAgICAgICAgICAgICAgPSBUcnVlLAogICAgICAgICAgICAgICAgIGxhenlfZW50cnlfcG9pbnRzICAgICAgICAgICAgICAgICAgPSBGYWxzZSwKICAgICAgICAgICAgICAgICBhbGxvd19zZWxmX3RyYW5zZmVyICAgICAgICAgICAgICAgID0gRmFsc2UsCiAgICAgICAgICAgICAgICAgdXNlX3Rva2VuX21ldGFkYXRhX29mZmNoYWluX3ZpZXcgICA9IFRydWUKICAgICAgICAgICAgICAgICApOgoKICAgICAgICBpZiBkZWJ1Z19tb2RlOgogICAgICAgICAgICBzZWxmLm15X21hcCA9IHNwLm1hcAogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlbGYubXlfbWFwID0gc3AuYmlnX21hcAogICAgICAgICMgVGhlIG9wdGlvbiBgZGVidWdfbW9kZWAgbWFrZXMgdGhlIGNvZGUgZ2VuZXJhdGlvbiB1c2UKICAgICAgICAjIHJlZ3VsYXIgbWFwcyBpbnN0ZWFkIG9mIGJpZy1tYXBzLCBoZW5jZSBpdCBtYWtlcyBpbnNwZWN0aW9uCiAgICAgICAgIyBvZiB0aGUgc3RhdGUgb2YgdGhlIGNvbnRyYWN0IGVhc2llci4KCiAgICAgICAgc2VsZi51c2VfdG9rZW5fbWV0YWRhdGFfb2ZmY2hhaW5fdmlldyA9IHVzZV90b2tlbl9tZXRhZGF0YV9vZmZjaGFpbl92aWV3CiAgICAgICAgIyBJbmNsdWRlIG9mZmNoYWluIHZpZXcgZm9yIGFjY2Vzc2luZyB0aGUgdG9rZW4gbWV0YWRhdGEgKHJlcXVpcmVzIFRaSVAtMDE2IGNvbnRyYWN0IG1ldGFkYXRhKQoKICAgICAgICBzZWxmLnNpbmdsZV9hc3NldCA9IHNpbmdsZV9hc3NldAogICAgICAgICMgVGhpcyBtYWtlcyB0aGUgY29udHJhY3Qgc2F2ZSBzb21lIGdhcyBhbmQgc3RvcmFnZSBieQogICAgICAgICMgd29ya2luZyBvbmx5IGZvciB0aGUgdG9rZW4taWQgYDBgLgoKICAgICAgICBzZWxmLm5vbl9mdW5naWJsZSA9IG5vbl9mdW5naWJsZQogICAgICAgICMgRW5mb3JjZSB0aGUgbm9uLWZ1bmdpYmlsaXR5IG9mIHRoZSB0b2tlbnMsIGkuZS4gdGhlIGZhY3QKICAgICAgICAjIHRoYXQgdG90YWwgc3VwcGx5IGhhcyB0byBiZSAxLgoKICAgICAgICBzZWxmLnJlYWRhYmxlID0gcmVhZGFibGUKICAgICAgICAjIFRoZSBgcmVhZGFibGVgIG9wdGlvbiBpcyBhIGxlZ2FjeSBzZXR0aW5nIHRoYXQgd2Uga2VlcCBhcm91bmQKICAgICAgICAjIG9ubHkgZm9yIGJlbmNobWFya2luZyBwdXJwb3Nlcy4KICAgICAgICAjCiAgICAgICAgIyBVc2VyLWFjY291bnRzIGFyZSBrZXB0IGluIGEgYmlnLW1hcDoKICAgICAgICAjIGAodXNlci1hZGRyZXNzICogdG9rZW4taWQpIC0+IG93bmVyc2hpcC1pbmZvYC4KICAgICAgICAjCiAgICAgICAgIyBGb3IgdGhlIEJhYnlsb24gcHJvdG9jb2wsIG9uZSBoYWQgdG8gdXNlIGByZWFkYWJsZSA9IEZhbHNlYAogICAgICAgICMgaW4gb3JkZXIgdG8gdXNlIGBQQUNLYCBvbiB0aGUga2V5cyBvZiB0aGUgYmlnLW1hcC4KCiAgICAgICAgc2VsZi5mb3JjZV9sYXlvdXRzID0gZm9yY2VfbGF5b3V0cwogICAgICAgICMgVGhlIHNwZWNpZmljYXRpb24gcmVxdWlyZXMgYWxsIGludGVyZmFjZS1mcm9udGluZyByZWNvcmRzCiAgICAgICAgIyBhbmQgdmFyaWFudHMgdG8gYmUgKnJpZ2h0LWNvbWJzOyogd2Uga2VlcAogICAgICAgICMgdGhpcyBwYXJhbWV0ZXIgdG8gYmUgYWJsZSB0byBjb21wYXJlIHBlcmZvcm1hbmNlICYgY29kZS1zaXplLgoKICAgICAgICBzZWxmLnN1cHBvcnRfb3BlcmF0b3IgPSBzdXBwb3J0X29wZXJhdG9yCiAgICAgICAgIyBUaGUgb3BlcmF0b3IgZW50cnktcG9pbnRzIGFsd2F5cyBoYXZlIHRvIGJlIHRoZXJlLCBidXQgdGhlcmUgaXMKICAgICAgICAjIGRlZmluaXRlbHkgYSB1c2UtY2FzZSBmb3IgaGF2aW5nIHRoZW0gY29tcGxldGVseSBlbXB0eSAoc2F2aW5nCiAgICAgICAgIyBzdG9yYWdlIGFuZCBnYXMgd2hlbiBgc3VwcG9ydF9vcGVyYXRvcmAgaXMgYEZhbHNlKS4KCiAgICAgICAgc2VsZi5hc3N1bWVfY29uc2VjdXRpdmVfdG9rZW5faWRzID0gYXNzdW1lX2NvbnNlY3V0aXZlX3Rva2VuX2lkcwogICAgICAgICMgRm9yIGEgcHJldmlvdXMgdmVyc2lvbiBvZiB0aGUgVFpJUCBzcGVjaWZpY2F0aW9uLCBpdCB3YXMKICAgICAgICAjIG5lY2Vzc2FyeSB0byBrZWVwIHRyYWNrIG9mIHRoZSBzZXQgb2YgYWxsIHRva2VucyBpbiB0aGUgY29udHJhY3QuCiAgICAgICAgIwogICAgICAgICMgVGhlIHNldCBvZiB0b2tlbnMgaXMgZm9yIG5vdyBzdGlsbCBhdmFpbGFibGU7IHRoaXMgcGFyYW1ldGVyCiAgICAgICAgIyBndWlkZXMgaG93IHRvIGltcGxlbWVudCBpdDoKICAgICAgICAjIElmIGB0cnVlYCB3ZSBkb24ndCBuZWVkIGEgcmVhbCBzZXQgb2YgdG9rZW4gaWRzLCBqdXN0IHRvIGtub3cgaG93CiAgICAgICAgIyBtYW55IHRoZXJlIGFyZS4KCiAgICAgICAgc2VsZi5zdG9yZV90b3RhbF9zdXBwbHkgPSBzdG9yZV90b3RhbF9zdXBwbHkKICAgICAgICAjIFdoZXRoZXIgdG8gc3RvcmUgdGhlIHRvdGFsLXN1cHBseSBmb3IgZWFjaCB0b2tlbiAobmV4dCB0bwogICAgICAgICMgdGhlIHRva2VuLW1ldGFkYXRhKS4KCiAgICAgICAgc2VsZi5hZGRfbXV0ZXpfdHJhbnNmZXIgPSBhZGRfbXV0ZXpfdHJhbnNmZXIKICAgICAgICAjIEFkZCBhbiBlbnRyeSBwb2ludCBmb3IgdGhlIGFkbWluaXN0cmF0b3IgdG8gdHJhbnNmZXIgdGV6IHBvdGVudGlhbGx5CiAgICAgICAgIyBpbiB0aGUgY29udHJhY3QncyBiYWxhbmNlLgoKICAgICAgICBzZWxmLmxhenlfZW50cnlfcG9pbnRzID0gbGF6eV9lbnRyeV9wb2ludHMKICAgICAgICAjCiAgICAgICAgIyBUaG9zZSBhcmUg4oCcY29tcGlsYXRpb27igJ0gb3B0aW9ucyBvZiBTbWFydFB5IGludG8gTWljaGVsc29uLgogICAgICAgICMKCiAgICAgICAgc2VsZi5hbGxvd19zZWxmX3RyYW5zZmVyID0gYWxsb3dfc2VsZl90cmFuc2ZlcgogICAgICAgICMgQXV0aG9yaXplIGNhbGwgb2YgYHRyYW5zZmVyYCBlbnRyeV9wb2ludCBmcm9tIHNlbGYKICAgICAgICBuYW1lID0gIkZBMiIKICAgICAgICBpZiBkZWJ1Z19tb2RlOgogICAgICAgICAgICBuYW1lICs9ICItZGVidWciCiAgICAgICAgaWYgc2luZ2xlX2Fzc2V0OgogICAgICAgICAgICBuYW1lICs9ICItc2luZ2xlX2Fzc2V0IgogICAgICAgIGlmIG5vbl9mdW5naWJsZToKICAgICAgICAgICAgbmFtZSArPSAiLW5mdCIKICAgICAgICBpZiBhZGRfbXV0ZXpfdHJhbnNmZXI6CiAgICAgICAgICAgIG5hbWUgKz0gIi1tdXRleiIKICAgICAgICBpZiBub3QgcmVhZGFibGU6CiAgICAgICAgICAgIG5hbWUgKz0gIi1ub19yZWFkYWJsZSIKICAgICAgICBpZiBub3QgZm9yY2VfbGF5b3V0czoKICAgICAgICAgICAgbmFtZSArPSAiLW5vX2xheW91dCIKICAgICAgICBpZiBub3Qgc3VwcG9ydF9vcGVyYXRvcjoKICAgICAgICAgICAgbmFtZSArPSAiLW5vX29wcyIKICAgICAgICBpZiBub3QgYXNzdW1lX2NvbnNlY3V0aXZlX3Rva2VuX2lkczoKICAgICAgICAgICAgbmFtZSArPSAiLW5vX3Rva25hdCIKICAgICAgICBpZiBub3Qgc3RvcmVfdG90YWxfc3VwcGx5OgogICAgICAgICAgICBuYW1lICs9ICItbm9fdG90c3VwIgogICAgICAgIGlmIGxhenlfZW50cnlfcG9pbnRzOgogICAgICAgICAgICBuYW1lICs9ICItbGVwIgogICAgICAgIGlmIGFsbG93X3NlbGZfdHJhbnNmZXI6CiAgICAgICAgICAgIG5hbWUgKz0gIi1zZWxmX3RyYW5zZmVyIgogICAgICAgIHNlbGYubmFtZSA9IG5hbWUKCiMjICMjIEF1eGlsaWFyeSBDbGFzc2VzIGFuZCBWYWx1ZXMKIyMKIyMgVGhlIGRlZmluaXRpb25zIGJlbG93IGltcGxlbWVudCBTbWFydE1MLXR5cGVzIGFuZCBmdW5jdGlvbnMgZm9yIHZhcmlvdXMKIyMgaW1wb3J0YW50IHR5cGVzLgojIwp0b2tlbl9pZF90eXBlID0gc3AuVE5hdAoKY2xhc3MgRXJyb3JfbWVzc2FnZToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjb25maWcpOgogICAgICAgIHNlbGYuY29uZmlnID0gY29uZmlnCiAgICAgICAgc2VsZi5wcmVmaXggPSAiRkEyXyIKICAgIGRlZiBtYWtlKHNlbGYsIHMpOiByZXR1cm4gKHNlbGYucHJlZml4ICsgcykKICAgIGRlZiB0b2tlbl91bmRlZmluZWQoc2VsZik6ICAgICAgIHJldHVybiBzZWxmLm1ha2UoIlRPS0VOX1VOREVGSU5FRCIpCiAgICBkZWYgaW5zdWZmaWNpZW50X2JhbGFuY2Uoc2VsZik6ICByZXR1cm4gc2VsZi5tYWtlKCJJTlNVRkZJQ0lFTlRfQkFMQU5DRSIpCiAgICBkZWYgbm90X29wZXJhdG9yKHNlbGYpOiAgICAgICAgICByZXR1cm4gc2VsZi5tYWtlKCJOT1RfT1BFUkFUT1IiKQogICAgZGVmIG5vdF9vd25lcihzZWxmKTogICAgICAgICAgICAgcmV0dXJuIHNlbGYubWFrZSgiTk9UX09XTkVSIikKICAgIGRlZiBvcGVyYXRvcnNfdW5zdXBwb3J0ZWQoc2VsZik6IHJldHVybiBzZWxmLm1ha2UoIk9QRVJBVE9SU19VTlNVUFBPUlRFRCIpCiAgICBkZWYgbm90X2FkbWluKHNlbGYpOiAgICAgICAgICAgICByZXR1cm4gc2VsZi5tYWtlKCJOT1RfQURNSU4iKQogICAgZGVmIG5vdF9hZG1pbl9vcl9vcGVyYXRvcihzZWxmKTogcmV0dXJuIHNlbGYubWFrZSgiTk9UX0FETUlOX09SX09QRVJBVE9SIikKICAgIGRlZiBwYXVzZWQoc2VsZik6ICAgICAgICAgICAgICAgIHJldHVybiBzZWxmLm1ha2UoIlBBVVNFRCIpCgojIyBUaGUgY3VycmVudCB0eXBlIGZvciBhIGJhdGNoZWQgdHJhbnNmZXIgaW4gdGhlIHNwZWNpZmljYXRpb24gaXMgYXMKIyMgZm9sbG93czoKIyMKIyMgYGBgb2NhbWwKIyMgdHlwZSB0cmFuc2ZlciA9IHsKIyMgICBmcm9tXyA6IGFkZHJlc3M7CiMjICAgdHhzOiB7CiMjICAgICB0b18gOiBhZGRyZXNzOwojIyAgICAgdG9rZW5faWQgOiB0b2tlbl9pZDsKIyMgICAgIGFtb3VudCA6IG5hdDsKIyMgICB9IGxpc3QKIyMgfSBsaXN0CiMjIGBgYAojIwojIyBUaGlzIGNsYXNzIHByb3ZpZGVzIGhlbHBlcnMgdG8gY3JlYXRlIGFuZCBmb3JjZSB0aGUgdHlwZSBvZiBzdWNoIGVsZW1lbnRzLgojIyBJdCB1c2VzIHRoZSBgRkEyX2NvbmZpZ2AgdG8gZGVjaWRlIHdoZXRoZXIgdG8gc2V0IHRoZSByaWdodC1jb21iIGxheW91dHMuCmNsYXNzIEJhdGNoX3RyYW5zZmVyOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGNvbmZpZyk6CiAgICAgICAgc2VsZi5jb25maWcgPSBjb25maWcKICAgIGRlZiBnZXRfdHJhbnNmZXJfdHlwZShzZWxmKToKICAgICAgICB0eF90eXBlID0gc3AuVFJlY29yZCh0b18gPSBzcC5UQWRkcmVzcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbl9pZCA9IHRva2VuX2lkX3R5cGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW1vdW50ID0gc3AuVE5hdCkKICAgICAgICBpZiBzZWxmLmNvbmZpZy5mb3JjZV9sYXlvdXRzOgogICAgICAgICAgICB0eF90eXBlID0gdHhfdHlwZS5sYXlvdXQoCiAgICAgICAgICAgICAgICAoInRvXyIsICgidG9rZW5faWQiLCAiYW1vdW50IikpCiAgICAgICAgICAgICkKICAgICAgICB0cmFuc2Zlcl90eXBlID0gc3AuVFJlY29yZChmcm9tXyA9IHNwLlRBZGRyZXNzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR4cyA9IHNwLlRMaXN0KHR4X3R5cGUpKS5sYXlvdXQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICgiZnJvbV8iLCAidHhzIikpCiAgICAgICAgcmV0dXJuIHRyYW5zZmVyX3R5cGUKICAgIGRlZiBnZXRfdHlwZShzZWxmKToKICAgICAgICByZXR1cm4gc3AuVExpc3Qoc2VsZi5nZXRfdHJhbnNmZXJfdHlwZSgpKQogICAgZGVmIGl0ZW0oc2VsZiwgZnJvbV8sIHR4cyk6CiAgICAgICAgdiA9IHNwLnJlY29yZChmcm9tXyA9IGZyb21fLCB0eHMgPSB0eHMpCiAgICAgICAgcmV0dXJuIHNwLnNldF90eXBlX2V4cHIodiwgc2VsZi5nZXRfdHJhbnNmZXJfdHlwZSgpKQojIwojIyBgT3BlcmF0b3JfcGFyYW1gIGRlZmluZXMgdHlwZSB0eXBlcyBmb3IgdGhlIGAldXBkYXRlX29wZXJhdG9yc2AgZW50cnktcG9pbnQuCmNsYXNzIE9wZXJhdG9yX3BhcmFtOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGNvbmZpZyk6CiAgICAgICAgc2VsZi5jb25maWcgPSBjb25maWcKICAgIGRlZiBnZXRfdHlwZShzZWxmKToKICAgICAgICB0ID0gc3AuVFJlY29yZCgKICAgICAgICAgICAgb3duZXIgPSBzcC5UQWRkcmVzcywKICAgICAgICAgICAgb3BlcmF0b3IgPSBzcC5UQWRkcmVzcywKICAgICAgICAgICAgdG9rZW5faWQgPSB0b2tlbl9pZF90eXBlKQogICAgICAgIGlmIHNlbGYuY29uZmlnLmZvcmNlX2xheW91dHM6CiAgICAgICAgICAgIHQgPSB0LmxheW91dCgoIm93bmVyIiwgKCJvcGVyYXRvciIsICJ0b2tlbl9pZCIpKSkKICAgICAgICByZXR1cm4gdAogICAgZGVmIG1ha2Uoc2VsZiwgb3duZXIsIG9wZXJhdG9yLCB0b2tlbl9pZCk6CiAgICAgICAgciA9IHNwLnJlY29yZChvd25lciA9IG93bmVyLAogICAgICAgICAgICAgICAgICAgICAgb3BlcmF0b3IgPSBvcGVyYXRvciwKICAgICAgICAgICAgICAgICAgICAgIHRva2VuX2lkID0gdG9rZW5faWQpCiAgICAgICAgcmV0dXJuIHNwLnNldF90eXBlX2V4cHIociwgc2VsZi5nZXRfdHlwZSgpKQoKIyMgVGhlIGNsYXNzIGBMZWRnZXJfa2V5YCBkZWZpbmVzIHRoZSBrZXkgdHlwZSBmb3IgdGhlIG1haW4gbGVkZ2VyIChiaWctKW1hcDoKIyMKIyMgLSBJbiAq4oCcQmFieWxvbiBtb2Rl4oCdKiB3ZSBhbHNvIGhhdmUgdG8gY2FsbCBgc3AucGFja2AuCiMjIC0gSW4gKuKAnHNpbmdsZS1hc3NldCBtb2Rl4oCdKiB3ZSBjYW4ganVzdCB1c2UgdGhlIHVzZXIncyBhZGRyZXNzLgpjbGFzcyBMZWRnZXJfa2V5OgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGNvbmZpZyk6CiAgICAgICAgc2VsZi5jb25maWcgPSBjb25maWcKICAgIGRlZiBtYWtlKHNlbGYsIHVzZXIsIHRva2VuKToKICAgICAgICB1c2VyID0gc3Auc2V0X3R5cGVfZXhwcih1c2VyLCBzcC5UQWRkcmVzcykKICAgICAgICB0b2tlbiA9IHNwLnNldF90eXBlX2V4cHIodG9rZW4sIHRva2VuX2lkX3R5cGUpCiAgICAgICAgaWYgc2VsZi5jb25maWcuc2luZ2xlX2Fzc2V0OgogICAgICAgICAgICByZXN1bHQgPSB1c2VyCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmVzdWx0ID0gc3AucGFpcih1c2VyLCB0b2tlbikKICAgICAgICBpZiBzZWxmLmNvbmZpZy5yZWFkYWJsZToKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdAogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzcC5wYWNrKHJlc3VsdCkKCiMjIEZvciBub3cgYSB2YWx1ZSBpbiB0aGUgbGVkZ2VyIGlzIGp1c3QgdGhlIHVzZXIncyBiYWxhbmNlLiBQcmV2aW91cwojIyB2ZXJzaW9ucyBvZiB0aGUgc3BlY2lmaWNhdGlvbiByZXF1aXJlZCBtb3JlIGluZm9ybWF0aW9uOyBwb3RlbnRpYWwKIyMgZXh0ZW5zaW9ucyBtYXkgcmVxdWlyZSBvdGhlciBmaWVsZHMuCmNsYXNzIExlZGdlcl92YWx1ZToKICAgIGRlZiBnZXRfdHlwZSgpOgogICAgICAgIHJldHVybiBzcC5UUmVjb3JkKGJhbGFuY2UgPSBzcC5UTmF0KQogICAgZGVmIG1ha2UoYmFsYW5jZSk6CiAgICAgICAgcmV0dXJuIHNwLnJlY29yZChiYWxhbmNlID0gYmFsYW5jZSkKCiMjIFRoZSBsaW5rIGJldHdlZW4gb3BlcmF0b3JzIGFuZCB0aGUgYWRkcmVzc2VzIHRoZXkgb3BlcmF0ZSBpcyBrZXB0CiMjIGluIGEgKmxhenkgc2V0KiBvZiBgKG93bmVyIMOXIG9wZXJhdG9yIMOXIHRva2VuLWlkKWAgdmFsdWVzLgojIwojIyBBIGxhenkgc2V0IGlzIGEgYmlnLW1hcCB3aG9zZSBrZXlzIGFyZSB0aGUgZWxlbWVudHMgb2YgdGhlIHNldCBhbmQKIyMgdmFsdWVzIGFyZSBhbGwgYFVuaXRgLgpjbGFzcyBPcGVyYXRvcl9zZXQ6CiAgICBkZWYgX19pbml0X18oc2VsZiwgY29uZmlnKToKICAgICAgICBzZWxmLmNvbmZpZyA9IGNvbmZpZwogICAgZGVmIGlubmVyX3R5cGUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNwLlRSZWNvcmQob3duZXIgPSBzcC5UQWRkcmVzcywKICAgICAgICAgICAgICAgICAgICAgICAgICBvcGVyYXRvciA9IHNwLlRBZGRyZXNzLAogICAgICAgICAgICAgICAgICAgICAgICAgIHRva2VuX2lkID0gdG9rZW5faWRfdHlwZQogICAgICAgICAgICAgICAgICAgICAgICAgICkubGF5b3V0KCgib3duZXIiLCAoIm9wZXJhdG9yIiwgInRva2VuX2lkIikpKQogICAgZGVmIGtleV90eXBlKHNlbGYpOgogICAgICAgIGlmIHNlbGYuY29uZmlnLnJlYWRhYmxlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5pbm5lcl90eXBlKCkKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc3AuVEJ5dGVzCiAgICBkZWYgbWFrZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5jb25maWcubXlfbWFwKHRrZXkgPSBzZWxmLmtleV90eXBlKCksIHR2YWx1ZSA9IHNwLlRVbml0KQogICAgZGVmIG1ha2Vfa2V5KHNlbGYsIG93bmVyLCBvcGVyYXRvciwgdG9rZW5faWQpOgogICAgICAgIG1ldGFrZXkgPSBzcC5yZWNvcmQob3duZXIgPSBvd25lciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wZXJhdG9yID0gb3BlcmF0b3IsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbl9pZCA9IHRva2VuX2lkKQogICAgICAgIG1ldGFrZXkgPSBzcC5zZXRfdHlwZV9leHByKG1ldGFrZXksIHNlbGYuaW5uZXJfdHlwZSgpKQogICAgICAgIGlmIHNlbGYuY29uZmlnLnJlYWRhYmxlOgogICAgICAgICAgICByZXR1cm4gbWV0YWtleQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzcC5wYWNrKG1ldGFrZXkpCiAgICBkZWYgYWRkKHNlbGYsIHNldCwgb3duZXIsIG9wZXJhdG9yLCB0b2tlbl9pZCk6CiAgICAgICAgc2V0W3NlbGYubWFrZV9rZXkob3duZXIsIG9wZXJhdG9yLCB0b2tlbl9pZCldID0gc3AudW5pdAogICAgZGVmIHJlbW92ZShzZWxmLCBzZXQsIG93bmVyLCBvcGVyYXRvciwgdG9rZW5faWQpOgogICAgICAgIGRlbCBzZXRbc2VsZi5tYWtlX2tleShvd25lciwgb3BlcmF0b3IsIHRva2VuX2lkKV0KICAgIGRlZiBpc19tZW1iZXIoc2VsZiwgc2V0LCBvd25lciwgb3BlcmF0b3IsIHRva2VuX2lkKToKICAgICAgICByZXR1cm4gc2V0LmNvbnRhaW5zKHNlbGYubWFrZV9rZXkob3duZXIsIG9wZXJhdG9yLCB0b2tlbl9pZCkpCgpjbGFzcyBCYWxhbmNlX29mOgogICAgZGVmIHJlcXVlc3RfdHlwZSgpOgogICAgICAgIHJldHVybiBzcC5UUmVjb3JkKAogICAgICAgICAgICBvd25lciA9IHNwLlRBZGRyZXNzLAogICAgICAgICAgICB0b2tlbl9pZCA9IHRva2VuX2lkX3R5cGUpLmxheW91dCgoIm93bmVyIiwgInRva2VuX2lkIikpCiAgICBkZWYgcmVzcG9uc2VfdHlwZSgpOgogICAgICAgIHJldHVybiBzcC5UTGlzdCgKICAgICAgICAgICAgc3AuVFJlY29yZCgKICAgICAgICAgICAgICAgIHJlcXVlc3QgPSBCYWxhbmNlX29mLnJlcXVlc3RfdHlwZSgpLAogICAgICAgICAgICAgICAgYmFsYW5jZSA9IHNwLlROYXQpLmxheW91dCgoInJlcXVlc3QiLCAiYmFsYW5jZSIpKSkKICAgIGRlZiBlbnRyeV9wb2ludF90eXBlKCk6CiAgICAgICAgcmV0dXJuIHNwLlRSZWNvcmQoCiAgICAgICAgICAgIGNhbGxiYWNrID0gc3AuVENvbnRyYWN0KEJhbGFuY2Vfb2YucmVzcG9uc2VfdHlwZSgpKSwKICAgICAgICAgICAgcmVxdWVzdHMgPSBzcC5UTGlzdChCYWxhbmNlX29mLnJlcXVlc3RfdHlwZSgpKQogICAgICAgICkubGF5b3V0KCgicmVxdWVzdHMiLCAiY2FsbGJhY2siKSkKCmNsYXNzIFRva2VuX21ldGFfZGF0YToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjb25maWcpOgogICAgICAgIHNlbGYuY29uZmlnID0gY29uZmlnCgogICAgZGVmIGdldF90eXBlKHNlbGYpOgogICAgICAgIHJldHVybiBzcC5UUmVjb3JkKHRva2VuX2lkID0gc3AuVE5hdCwgdG9rZW5faW5mbyA9IHNwLlRNYXAoc3AuVFN0cmluZywgc3AuVEJ5dGVzKSkKCiAgICBkZWYgc2V0X3R5cGVfYW5kX2xheW91dChzZWxmLCBleHByKToKICAgICAgICBzcC5zZXRfdHlwZShleHByLCBzZWxmLmdldF90eXBlKCkpCgojIyBUaGUgc2V0IG9mIGFsbCB0b2tlbnMgaXMgcmVwcmVzZW50ZWQgYnkgYSBgbmF0YCBpZiB3ZSBhc3N1bWUgdGhhdCB0b2tlbi1pZHMKIyMgYXJlIGNvbnNlY3V0aXZlLCBvciBieSBhbiBhY3R1YWwgYChzZXQgbmF0KWAgaWYgbm90LgojIwojIyAtIEtub3dpbmcgdGhlIHNldCBvZiB0b2tlbnMgaXMgdXNlZnVsIGZvciB0aHJvd2luZyBhY2N1cmF0ZSBlcnJvciBtZXNzYWdlcy4KIyMgLSBQcmV2aW91cyB2ZXJzaW9ucyBvZiB0aGUgc3BlY2lmaWNhdGlvbiByZXF1aXJlZCB0aGlzIHNldCBmb3IgZnVuY3Rpb25hbAojIyAgIGJlaGF2aW9yIChvcGVyYXRvcnMgaW50ZXJmYWNlIGhhZCB0byBkZWFsIHdpdGgg4oCcYWxsIHRva2Vuc+KAnSkuCmNsYXNzIFRva2VuX2lkX3NldDoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjb25maWcpOgogICAgICAgIHNlbGYuY29uZmlnID0gY29uZmlnCiAgICBkZWYgZW1wdHkoc2VsZik6CiAgICAgICAgaWYgc2VsZi5jb25maWcuYXNzdW1lX2NvbnNlY3V0aXZlX3Rva2VuX2lkczoKICAgICAgICAgICAgIyBUaGUgInNldCIgaXMgaXRzIGNhcmRpbmFsLgogICAgICAgICAgICByZXR1cm4gc3AubmF0KDApCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNwLnNldCh0ID0gdG9rZW5faWRfdHlwZSkKICAgIGRlZiBhZGQoc2VsZiwgdG90YWxUb2tlbnMsIHRva2VuSUQpOgogICAgICAgIGlmIHNlbGYuY29uZmlnLmFzc3VtZV9jb25zZWN1dGl2ZV90b2tlbl9pZHM6CiAgICAgICAgICAgIHNwLnZlcmlmeSh0b3RhbFRva2VucyA9PSB0b2tlbklELCBtZXNzYWdlID0gIlRva2VuLUlEcyBzaG91bGQgYmUgY29uc2VjdXRpdmUiKQogICAgICAgICAgICB0b3RhbFRva2Vucy5zZXQodG9rZW5JRCArIDEpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgdG90YWxUb2tlbnMuYWRkKHRva2VuSUQpCiAgICBkZWYgY29udGFpbnMoc2VsZiwgdG90YWxUb2tlbnMsIHRva2VuSUQpOgogICAgICAgIGlmIHNlbGYuY29uZmlnLmFzc3VtZV9jb25zZWN1dGl2ZV90b2tlbl9pZHM6CiAgICAgICAgICAgIHJldHVybiAodG9rZW5JRCA8IHRvdGFsVG9rZW5zKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiB0b3RhbFRva2Vucy5jb250YWlucyh0b2tlbklEKQogICAgZGVmIGNhcmRpbmFsKHNlbGYsIHRvdGFsVG9rZW5zKToKICAgICAgICBpZiBzZWxmLmNvbmZpZy5hc3N1bWVfY29uc2VjdXRpdmVfdG9rZW5faWRzOgogICAgICAgICAgICByZXR1cm4gdG90YWxUb2tlbnMKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc3AubGVuKHRvdGFsVG9rZW5zKQoKIyMKIyMgIyMgSW1wbGVtZW50YXRpb24gb2YgdGhlIENvbnRyYWN0CiMjCiMjIGBtdXRlel90cmFuc2ZlcmAgaXMgYW4gb3B0aW9uYWwgZW50cnktcG9pbnQsIGhlbmNlIHdlIGRlZmluZSBpdCDigJxvdXRzaWRl4oCdIHRoZQojIyBjbGFzczoKZGVmIG11dGV6X3RyYW5zZmVyKGNvbnRyYWN0LCBwYXJhbXMpOgogICAgc3AudmVyaWZ5KHNwLnNlbmRlciA9PSBjb250cmFjdC5kYXRhLmFkbWluaXN0cmF0b3IpCiAgICBzcC5zZXRfdHlwZShwYXJhbXMuZGVzdGluYXRpb24sIHNwLlRBZGRyZXNzKQogICAgc3Auc2V0X3R5cGUocGFyYW1zLmFtb3VudCwgc3AuVE11dGV6KQogICAgc3Auc2VuZChwYXJhbXMuZGVzdGluYXRpb24sIHBhcmFtcy5hbW91bnQpCiMjCiMjIFRoZSBgRkEyYCBjbGFzcyBidWlsZHMgYSBjb250cmFjdCBhY2NvcmRpbmcgdG8gYW4gYEZBMl9jb25maWdgIGFuZCBhbgojIyBhZG1pbmlzdHJhdG9yIGFkZHJlc3MuCiMjIEl0IGlzIGluaGVyaXRpbmcgZnJvbSBgRkEyX2NvcmVgIHdoaWNoIGltcGxlbWVudHMgdGhlIHN0cmljdAojIyBzdGFuZGFyZCBhbmQgYSBmZXcgb3RoZXIgY2xhc3NlcyB0byBhZGQgb3RoZXIgY29tbW9uIGZlYXR1cmVzLgojIwojIyAtIFdlIHNlZSB0aGUgdXNlIG9mCiMjICAgW2BzcC5lbnRyeV9wb2ludGBdKGh0dHBzOi8vc21hcnRweS5pby9kb2NzL2ludHJvZHVjdGlvbi9lbnRyeV9wb2ludHMpCiMjICAgYXMgYSBmdW5jdGlvbiBpbnN0ZWFkIG9mIHVzaW5nIGFubm90YXRpb25zIGluIG9yZGVyIHRvIGFsbG93CiMjICAgb3B0aW9uYWwgZW50cnkgcG9pbnRzLgojIyAtIFRoZSBzdG9yYWdlIGZpZWxkIGBtZXRhZGF0YV9zdHJpbmdgIGlzIGEgcGxhY2Vob2xkZXIsIHRoZSBidWlsZAojIyAgIHN5c3RlbSByZXBsYWNlcyB0aGUgZmllbGQgYW5ub3RhdGlvbiB3aXRoIGEgc3BlY2lmaWMgdmVyc2lvbi1zdHJpbmcsIHN1Y2gKIyMgICBhcyBgInZlcnNpb25fMjAyMDA2MDJfdHppcF9iOTE2ZjMyImA6IHRoZSB2ZXJzaW9uIG9mIEZBMi1zbWFydHB5IGFuZAojIyAgIHRoZSBnaXQgY29tbWl0IGluIHRoZSBUWklQIFtyZXBvc2l0b3J5XShodHRwczovL2dpdGxhYi5jb20vdHppcC90emlwKSB0aGF0CiMjICAgdGhlIGNvbnRyYWN0IHNob3VsZCBvYmV5LgpjbGFzcyBGQTJfY29yZShzcC5Db250cmFjdCk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgY29uZmlnLCBtZXRhZGF0YSwgKipleHRyYV9zdG9yYWdlKToKICAgICAgICBzZWxmLmNvbmZpZyA9IGNvbmZpZwogICAgICAgIHNlbGYuZXJyb3JfbWVzc2FnZSA9IEVycm9yX21lc3NhZ2Uoc2VsZi5jb25maWcpCiAgICAgICAgc2VsZi5vcGVyYXRvcl9zZXQgPSBPcGVyYXRvcl9zZXQoc2VsZi5jb25maWcpCiAgICAgICAgc2VsZi5vcGVyYXRvcl9wYXJhbSA9IE9wZXJhdG9yX3BhcmFtKHNlbGYuY29uZmlnKQogICAgICAgIHNlbGYudG9rZW5faWRfc2V0ID0gVG9rZW5faWRfc2V0KHNlbGYuY29uZmlnKQogICAgICAgIHNlbGYubGVkZ2VyX2tleSA9IExlZGdlcl9rZXkoc2VsZi5jb25maWcpCiAgICAgICAgc2VsZi50b2tlbl9tZXRhX2RhdGEgPSBUb2tlbl9tZXRhX2RhdGEoc2VsZi5jb25maWcpCiAgICAgICAgc2VsZi5iYXRjaF90cmFuc2ZlciAgICA9IEJhdGNoX3RyYW5zZmVyKHNlbGYuY29uZmlnKQogICAgICAgIGlmICBzZWxmLmNvbmZpZy5hZGRfbXV0ZXpfdHJhbnNmZXI6CiAgICAgICAgICAgIHNlbGYudHJhbnNmZXJfbXV0ZXogPSBzcC5lbnRyeV9wb2ludChtdXRlel90cmFuc2ZlcikKICAgICAgICBpZiBjb25maWcubGF6eV9lbnRyeV9wb2ludHM6CiAgICAgICAgICAgIHNlbGYuYWRkX2ZsYWcoImxhenktZW50cnktcG9pbnRzIikKICAgICAgICBzZWxmLmFkZF9mbGFnKCJpbml0aWFsLWNhc3QiKQogICAgICAgIHNlbGYuZXhjZXB0aW9uX29wdGltaXphdGlvbl9sZXZlbCA9ICJkZWZhdWx0LWxpbmUiCiAgICAgICAgc2VsZi5pbml0KAogICAgICAgICAgICBsZWRnZXIgPSBzZWxmLmNvbmZpZy5teV9tYXAodHZhbHVlID0gTGVkZ2VyX3ZhbHVlLmdldF90eXBlKCkpLAogICAgICAgICAgICB0b2tlbl9tZXRhZGF0YSA9IHNlbGYuY29uZmlnLm15X21hcCh0a2V5ID0gc3AuVE5hdCwgdHZhbHVlID0gc2VsZi50b2tlbl9tZXRhX2RhdGEuZ2V0X3R5cGUoKSksCiAgICAgICAgICAgIG9wZXJhdG9ycyA9IHNlbGYub3BlcmF0b3Jfc2V0Lm1ha2UoKSwKICAgICAgICAgICAgYWxsX3Rva2VucyA9IHNlbGYudG9rZW5faWRfc2V0LmVtcHR5KCksCiAgICAgICAgICAgIG1ldGFkYXRhID0gbWV0YWRhdGEsCiAgICAgICAgICAgICoqZXh0cmFfc3RvcmFnZQogICAgICAgICkKCiAgICAgICAgaWYgc2VsZi5jb25maWcuc3RvcmVfdG90YWxfc3VwcGx5OgogICAgICAgICAgICBzZWxmLnVwZGF0ZV9pbml0aWFsX3N0b3JhZ2UoCiAgICAgICAgICAgICAgICB0b3RhbF9zdXBwbHkgPSBzZWxmLmNvbmZpZy5teV9tYXAodGtleSA9IHNwLlROYXQsIHR2YWx1ZSA9IHNwLlROYXQpLAogICAgICAgICAgICApCgogICAgQHNwLmVudHJ5X3BvaW50CiAgICBkZWYgdHJhbnNmZXIoc2VsZiwgcGFyYW1zKToKICAgICAgICBzcC52ZXJpZnkoIH5zZWxmLmlzX3BhdXNlZCgpLCBtZXNzYWdlID0gc2VsZi5lcnJvcl9tZXNzYWdlLnBhdXNlZCgpICkKICAgICAgICBzcC5zZXRfdHlwZShwYXJhbXMsIHNlbGYuYmF0Y2hfdHJhbnNmZXIuZ2V0X3R5cGUoKSkKICAgICAgICBzcC5mb3IgdHJhbnNmZXIgaW4gcGFyYW1zOgogICAgICAgICAgIGN1cnJlbnRfZnJvbSA9IHRyYW5zZmVyLmZyb21fCiAgICAgICAgICAgc3AuZm9yIHR4IGluIHRyYW5zZmVyLnR4czoKICAgICAgICAgICAgICAgIGlmIHNlbGYuY29uZmlnLnNpbmdsZV9hc3NldDoKICAgICAgICAgICAgICAgICAgICBzcC52ZXJpZnkodHgudG9rZW5faWQgPT0gMCwgbWVzc2FnZSA9ICJzaW5nbGUtYXNzZXQ6IHRva2VuLWlkIDw+IDAiKQoKICAgICAgICAgICAgICAgIHNlbmRlcl92ZXJpZnkgPSAoKHNlbGYuaXNfYWRtaW5pc3RyYXRvcihzcC5zZW5kZXIpKSB8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGN1cnJlbnRfZnJvbSA9PSBzcC5zZW5kZXIpKQogICAgICAgICAgICAgICAgbWVzc2FnZSA9IHNlbGYuZXJyb3JfbWVzc2FnZS5ub3Rfb3duZXIoKQogICAgICAgICAgICAgICAgaWYgc2VsZi5jb25maWcuc3VwcG9ydF9vcGVyYXRvcjoKICAgICAgICAgICAgICAgICAgICBtZXNzYWdlID0gc2VsZi5lcnJvcl9tZXNzYWdlLm5vdF9vcGVyYXRvcigpCiAgICAgICAgICAgICAgICAgICAgc2VuZGVyX3ZlcmlmeSB8PSAoc2VsZi5vcGVyYXRvcl9zZXQuaXNfbWVtYmVyKHNlbGYuZGF0YS5vcGVyYXRvcnMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfZnJvbSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Auc2VuZGVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eC50b2tlbl9pZCkpCiAgICAgICAgICAgICAgICBpZiBzZWxmLmNvbmZpZy5hbGxvd19zZWxmX3RyYW5zZmVyOgogICAgICAgICAgICAgICAgICAgIHNlbmRlcl92ZXJpZnkgfD0gKHNwLnNlbmRlciA9PSBzcC5zZWxmX2FkZHJlc3MpCiAgICAgICAgICAgICAgICBzcC52ZXJpZnkoc2VuZGVyX3ZlcmlmeSwgbWVzc2FnZSA9IG1lc3NhZ2UpCiAgICAgICAgICAgICAgICBzcC52ZXJpZnkoCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYXRhLnRva2VuX21ldGFkYXRhLmNvbnRhaW5zKHR4LnRva2VuX2lkKSwKICAgICAgICAgICAgICAgICAgICBtZXNzYWdlID0gc2VsZi5lcnJvcl9tZXNzYWdlLnRva2VuX3VuZGVmaW5lZCgpCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAjIElmIGFtb3VudCBpcyAwIHdlIGRvIG5vdGhpbmcgbm93OgogICAgICAgICAgICAgICAgc3AuaWYgKHR4LmFtb3VudCA+IDApOgogICAgICAgICAgICAgICAgICAgIGZyb21fdXNlciA9IHNlbGYubGVkZ2VyX2tleS5tYWtlKGN1cnJlbnRfZnJvbSwgdHgudG9rZW5faWQpCiAgICAgICAgICAgICAgICAgICAgc3AudmVyaWZ5KAogICAgICAgICAgICAgICAgICAgICAgICAoc2VsZi5kYXRhLmxlZGdlcltmcm9tX3VzZXJdLmJhbGFuY2UgPj0gdHguYW1vdW50KSwKICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZSA9IHNlbGYuZXJyb3JfbWVzc2FnZS5pbnN1ZmZpY2llbnRfYmFsYW5jZSgpKQogICAgICAgICAgICAgICAgICAgIHRvX3VzZXIgPSBzZWxmLmxlZGdlcl9rZXkubWFrZSh0eC50b18sIHR4LnRva2VuX2lkKQogICAgICAgICAgICAgICAgICAgIHNlbGYuZGF0YS5sZWRnZXJbZnJvbV91c2VyXS5iYWxhbmNlID0gc3AuYXNfbmF0KAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRhdGEubGVkZ2VyW2Zyb21fdXNlcl0uYmFsYW5jZSAtIHR4LmFtb3VudCkKICAgICAgICAgICAgICAgICAgICBzcC5pZiBzZWxmLmRhdGEubGVkZ2VyLmNvbnRhaW5zKHRvX3VzZXIpOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRhdGEubGVkZ2VyW3RvX3VzZXJdLmJhbGFuY2UgKz0gdHguYW1vdW50CiAgICAgICAgICAgICAgICAgICAgc3AuZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGF0YS5sZWRnZXJbdG9fdXNlcl0gPSBMZWRnZXJfdmFsdWUubWFrZSh0eC5hbW91bnQpCiAgICAgICAgICAgICAgICBzcC5lbHNlOgogICAgICAgICAgICAgICAgICAgIHBhc3MKCiAgICBAc3AuZW50cnlfcG9pbnQKICAgIGRlZiBiYWxhbmNlX29mKHNlbGYsIHBhcmFtcyk6CiAgICAgICAgIyBwYXVzZWQgbWF5IG1lYW4gdGhhdCBiYWxhbmNlcyBhcmUgbWVhbmluZ2xlc3M6CiAgICAgICAgc3AudmVyaWZ5KCB+c2VsZi5pc19wYXVzZWQoKSwgbWVzc2FnZSA9IHNlbGYuZXJyb3JfbWVzc2FnZS5wYXVzZWQoKSkKICAgICAgICBzcC5zZXRfdHlwZShwYXJhbXMsIEJhbGFuY2Vfb2YuZW50cnlfcG9pbnRfdHlwZSgpKQogICAgICAgIGRlZiBmX3Byb2Nlc3NfcmVxdWVzdChyZXEpOgogICAgICAgICAgICB1c2VyID0gc2VsZi5sZWRnZXJfa2V5Lm1ha2UocmVxLm93bmVyLCByZXEudG9rZW5faWQpCiAgICAgICAgICAgIHNwLnZlcmlmeShzZWxmLmRhdGEudG9rZW5fbWV0YWRhdGEuY29udGFpbnMocmVxLnRva2VuX2lkKSwgbWVzc2FnZSA9IHNlbGYuZXJyb3JfbWVzc2FnZS50b2tlbl91bmRlZmluZWQoKSkKICAgICAgICAgICAgc3AuaWYgc2VsZi5kYXRhLmxlZGdlci5jb250YWlucyh1c2VyKToKICAgICAgICAgICAgICAgIGJhbGFuY2UgPSBzZWxmLmRhdGEubGVkZ2VyW3VzZXJdLmJhbGFuY2UKICAgICAgICAgICAgICAgIHNwLnJlc3VsdCgKICAgICAgICAgICAgICAgICAgICBzcC5yZWNvcmQoCiAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVlc3QgPSBzcC5yZWNvcmQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvd25lciA9IHNwLnNldF90eXBlX2V4cHIocmVxLm93bmVyLCBzcC5UQWRkcmVzcyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbl9pZCA9IHNwLnNldF90eXBlX2V4cHIocmVxLnRva2VuX2lkLCBzcC5UTmF0KSksCiAgICAgICAgICAgICAgICAgICAgICAgIGJhbGFuY2UgPSBiYWxhbmNlKSkKICAgICAgICAgICAgc3AuZWxzZToKICAgICAgICAgICAgICAgIHNwLnJlc3VsdCgKICAgICAgICAgICAgICAgICAgICBzcC5yZWNvcmQoCiAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVlc3QgPSBzcC5yZWNvcmQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvd25lciA9IHNwLnNldF90eXBlX2V4cHIocmVxLm93bmVyLCBzcC5UQWRkcmVzcyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbl9pZCA9IHNwLnNldF90eXBlX2V4cHIocmVxLnRva2VuX2lkLCBzcC5UTmF0KSksCiAgICAgICAgICAgICAgICAgICAgICAgIGJhbGFuY2UgPSAwKSkKICAgICAgICByZXMgPSBzcC5sb2NhbCgicmVzcG9uc2VzIiwgcGFyYW1zLnJlcXVlc3RzLm1hcChmX3Byb2Nlc3NfcmVxdWVzdCkpCiAgICAgICAgZGVzdGluYXRpb24gPSBzcC5zZXRfdHlwZV9leHByKHBhcmFtcy5jYWxsYmFjaywgc3AuVENvbnRyYWN0KEJhbGFuY2Vfb2YucmVzcG9uc2VfdHlwZSgpKSkKICAgICAgICBzcC50cmFuc2ZlcihyZXMudmFsdWUsIHNwLm11dGV6KDApLCBkZXN0aW5hdGlvbikKCiAgICBAc3Aub2ZmY2hhaW5fdmlldyhwdXJlID0gVHJ1ZSkKICAgIGRlZiBnZXRfYmFsYW5jZShzZWxmLCByZXEpOgogICAgICAgICIiIlRoaXMgaXMgdGhlIGBnZXRfYmFsYW5jZWAgdmlldyBkZWZpbmVkIGluIFRaSVAtMTIuIiIiCiAgICAgICAgc3Auc2V0X3R5cGUoCiAgICAgICAgICAgIHJlcSwgc3AuVFJlY29yZCgKICAgICAgICAgICAgICAgIG93bmVyID0gc3AuVEFkZHJlc3MsCiAgICAgICAgICAgICAgICB0b2tlbl9pZCA9IHNwLlROYXQKICAgICAgICAgICAgKS5sYXlvdXQoKCJvd25lciIsICJ0b2tlbl9pZCIpKSkKICAgICAgICB1c2VyID0gc2VsZi5sZWRnZXJfa2V5Lm1ha2UocmVxLm93bmVyLCByZXEudG9rZW5faWQpCiAgICAgICAgc3AudmVyaWZ5KHNlbGYuZGF0YS50b2tlbl9tZXRhZGF0YS5jb250YWlucyhyZXEudG9rZW5faWQpLCBtZXNzYWdlID0gc2VsZi5lcnJvcl9tZXNzYWdlLnRva2VuX3VuZGVmaW5lZCgpKQogICAgICAgIHNwLnJlc3VsdChzZWxmLmRhdGEubGVkZ2VyW3VzZXJdLmJhbGFuY2UpCgoKICAgIEBzcC5lbnRyeV9wb2ludAogICAgZGVmIHVwZGF0ZV9vcGVyYXRvcnMoc2VsZiwgcGFyYW1zKToKICAgICAgICBzcC5zZXRfdHlwZShwYXJhbXMsIHNwLlRMaXN0KAogICAgICAgICAgICBzcC5UVmFyaWFudCgKICAgICAgICAgICAgICAgIGFkZF9vcGVyYXRvciA9IHNlbGYub3BlcmF0b3JfcGFyYW0uZ2V0X3R5cGUoKSwKICAgICAgICAgICAgICAgIHJlbW92ZV9vcGVyYXRvciA9IHNlbGYub3BlcmF0b3JfcGFyYW0uZ2V0X3R5cGUoKQogICAgICAgICAgICApCiAgICAgICAgKSkKICAgICAgICBpZiBzZWxmLmNvbmZpZy5zdXBwb3J0X29wZXJhdG9yOgogICAgICAgICAgICBzcC5mb3IgdXBkYXRlIGluIHBhcmFtczoKICAgICAgICAgICAgICAgIHdpdGggdXBkYXRlLm1hdGNoX2Nhc2VzKCkgYXMgYXJnOgogICAgICAgICAgICAgICAgICAgIHdpdGggYXJnLm1hdGNoKCJhZGRfb3BlcmF0b3IiKSBhcyB1cGQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHNwLnZlcmlmeSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICh1cGQub3duZXIgPT0gc3Auc2VuZGVyKSB8IHNlbGYuaXNfYWRtaW5pc3RyYXRvcihzcC5zZW5kZXIpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZSA9IHNlbGYuZXJyb3JfbWVzc2FnZS5ub3RfYWRtaW5fb3Jfb3BlcmF0b3IoKQogICAgICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYub3BlcmF0b3Jfc2V0LmFkZChzZWxmLmRhdGEub3BlcmF0b3JzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkLm93bmVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkLm9wZXJhdG9yLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkLnRva2VuX2lkKQogICAgICAgICAgICAgICAgICAgIHdpdGggYXJnLm1hdGNoKCJyZW1vdmVfb3BlcmF0b3IiKSBhcyB1cGQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHNwLnZlcmlmeSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICh1cGQub3duZXIgPT0gc3Auc2VuZGVyKSB8IHNlbGYuaXNfYWRtaW5pc3RyYXRvcihzcC5zZW5kZXIpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZSA9IHNlbGYuZXJyb3JfbWVzc2FnZS5ub3RfYWRtaW5fb3Jfb3BlcmF0b3IoKQogICAgICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYub3BlcmF0b3Jfc2V0LnJlbW92ZShzZWxmLmRhdGEub3BlcmF0b3JzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkLm93bmVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkLm9wZXJhdG9yLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkLnRva2VuX2lkKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNwLmZhaWx3aXRoKHNlbGYuZXJyb3JfbWVzc2FnZS5vcGVyYXRvcnNfdW5zdXBwb3J0ZWQoKSkKCiAgICAjIHRoaXMgaXMgbm90IHBhcnQgb2YgdGhlIHN0YW5kYXJkIGJ1dCBjYW4gYmUgc3VwcG9ydGVkIHRocm91Z2ggaW5oZXJpdGFuY2UuCiAgICBkZWYgaXNfcGF1c2VkKHNlbGYpOgogICAgICAgIHJldHVybiBzcC5ib29sKEZhbHNlKQoKICAgICMgdGhpcyBpcyBub3QgcGFydCBvZiB0aGUgc3RhbmRhcmQgYnV0IGNhbiBiZSBzdXBwb3J0ZWQgdGhyb3VnaCBpbmhlcml0YW5jZS4KICAgIGRlZiBpc19hZG1pbmlzdHJhdG9yKHNlbGYsIHNlbmRlcik6CiAgICAgICAgcmV0dXJuIHNwLmJvb2woRmFsc2UpCgpjbGFzcyBGQTJfYWRtaW5pc3RyYXRvcihGQTJfY29yZSk6CiAgICBkZWYgaXNfYWRtaW5pc3RyYXRvcihzZWxmLCBzZW5kZXIpOgogICAgICAgIHJldHVybiBzZW5kZXIgPT0gc2VsZi5kYXRhLmFkbWluaXN0cmF0b3IKCiAgICBAc3AuZW50cnlfcG9pbnQKICAgIGRlZiBzZXRfYWRtaW5pc3RyYXRvcihzZWxmLCBwYXJhbXMpOgogICAgICAgIHNwLnZlcmlmeShzZWxmLmlzX2FkbWluaXN0cmF0b3Ioc3Auc2VuZGVyKSwgbWVzc2FnZSA9IHNlbGYuZXJyb3JfbWVzc2FnZS5ub3RfYWRtaW4oKSkKICAgICAgICBzZWxmLmRhdGEuYWRtaW5pc3RyYXRvciA9IHBhcmFtcwoKY2xhc3MgRkEyX3BhdXNlKEZBMl9jb3JlKToKICAgIGRlZiBpc19wYXVzZWQoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuZGF0YS5wYXVzZWQKCiAgICBAc3AuZW50cnlfcG9pbnQKICAgIGRlZiBzZXRfcGF1c2Uoc2VsZiwgcGFyYW1zKToKICAgICAgICBzcC52ZXJpZnkoc2VsZi5pc19hZG1pbmlzdHJhdG9yKHNwLnNlbmRlciksIG1lc3NhZ2UgPSBzZWxmLmVycm9yX21lc3NhZ2Uubm90X2FkbWluKCkpCiAgICAgICAgc2VsZi5kYXRhLnBhdXNlZCA9IHBhcmFtcwoKY2xhc3MgRkEyX2NoYW5nZV9tZXRhZGF0YShGQTJfY29yZSk6CiAgICBAc3AuZW50cnlfcG9pbnQKICAgIGRlZiBzZXRfbWV0YWRhdGEoc2VsZiwgaywgdik6CiAgICAgICAgc3AudmVyaWZ5KHNlbGYuaXNfYWRtaW5pc3RyYXRvcihzcC5zZW5kZXIpLCBtZXNzYWdlID0gc2VsZi5lcnJvcl9tZXNzYWdlLm5vdF9hZG1pbigpKQogICAgICAgIHNlbGYuZGF0YS5tZXRhZGF0YVtrXSA9IHYKCmNsYXNzIEZBMl9taW50KEZBMl9jb3JlKToKICAgIEBzcC5lbnRyeV9wb2ludAogICAgZGVmIG1pbnQoc2VsZiwgcGFyYW1zKToKICAgICAgICBzcC52ZXJpZnkoc2VsZi5pc19hZG1pbmlzdHJhdG9yKHNwLnNlbmRlciksIG1lc3NhZ2UgPSBzZWxmLmVycm9yX21lc3NhZ2Uubm90X2FkbWluKCkpCiAgICAgICAgIyBXZSBkb24ndCBjaGVjayBmb3IgcGF1c2VuZXNzIGJlY2F1c2Ugd2UncmUgdGhlIGFkbWluLgogICAgICAgIGlmIHNlbGYuY29uZmlnLnNpbmdsZV9hc3NldDoKICAgICAgICAgICAgc3AudmVyaWZ5KHBhcmFtcy50b2tlbl9pZCA9PSAwLCBtZXNzYWdlID0gInNpbmdsZS1hc3NldDogdG9rZW4taWQgPD4gMCIpCiAgICAgICAgaWYgc2VsZi5jb25maWcubm9uX2Z1bmdpYmxlOgogICAgICAgICAgICBzcC52ZXJpZnkocGFyYW1zLmFtb3VudCA9PSAxLCBtZXNzYWdlID0gIk5GVC1hc3NldDogYW1vdW50IDw+IDEiKQogICAgICAgICAgICBzcC52ZXJpZnkoCiAgICAgICAgICAgICAgICB+IHNlbGYudG9rZW5faWRfc2V0LmNvbnRhaW5zKHNlbGYuZGF0YS5hbGxfdG9rZW5zLCBwYXJhbXMudG9rZW5faWQpLAogICAgICAgICAgICAgICAgbWVzc2FnZSA9ICJORlQtYXNzZXQ6IGNhbm5vdCBtaW50IHR3aWNlIHNhbWUgdG9rZW4iCiAgICAgICAgICAgICkKICAgICAgICB1c2VyID0gc2VsZi5sZWRnZXJfa2V5Lm1ha2UocGFyYW1zLmFkZHJlc3MsIHBhcmFtcy50b2tlbl9pZCkKICAgICAgICBzcC5pZiBzZWxmLmRhdGEubGVkZ2VyLmNvbnRhaW5zKHVzZXIpOgogICAgICAgICAgICBzZWxmLmRhdGEubGVkZ2VyW3VzZXJdLmJhbGFuY2UgKz0gcGFyYW1zLmFtb3VudAogICAgICAgIHNwLmVsc2U6CiAgICAgICAgICAgIHNlbGYuZGF0YS5sZWRnZXJbdXNlcl0gPSBMZWRnZXJfdmFsdWUubWFrZShwYXJhbXMuYW1vdW50KQogICAgICAgIHNwLmlmIH4gc2VsZi50b2tlbl9pZF9zZXQuY29udGFpbnMoc2VsZi5kYXRhLmFsbF90b2tlbnMsIHBhcmFtcy50b2tlbl9pZCk6CiAgICAgICAgICAgIHNlbGYudG9rZW5faWRfc2V0LmFkZChzZWxmLmRhdGEuYWxsX3Rva2VucywgcGFyYW1zLnRva2VuX2lkKQogICAgICAgICAgICBzZWxmLmRhdGEudG9rZW5fbWV0YWRhdGFbcGFyYW1zLnRva2VuX2lkXSA9IHNwLnJlY29yZCgKICAgICAgICAgICAgICAgIHRva2VuX2lkICAgID0gcGFyYW1zLnRva2VuX2lkLAogICAgICAgICAgICAgICAgdG9rZW5faW5mbyAgPSBwYXJhbXMubWV0YWRhdGEKICAgICAgICAgICAgKQogICAgICAgIGlmIHNlbGYuY29uZmlnLnN0b3JlX3RvdGFsX3N1cHBseToKICAgICAgICAgICAgc2VsZi5kYXRhLnRvdGFsX3N1cHBseVtwYXJhbXMudG9rZW5faWRdID0gcGFyYW1zLmFtb3VudCArIHNlbGYuZGF0YS50b3RhbF9zdXBwbHkuZ2V0KHBhcmFtcy50b2tlbl9pZCwgZGVmYXVsdF92YWx1ZSA9IDApCgpjbGFzcyBGQTJfdG9rZW5fbWV0YWRhdGEoRkEyX2NvcmUpOgogICAgZGVmIHNldF90b2tlbl9tZXRhZGF0YV92aWV3KHNlbGYpOgogICAgICAgIGRlZiB0b2tlbl9tZXRhZGF0YShzZWxmLCB0b2spOgogICAgICAgICAgICAiIiIKICAgICAgICAgICAgUmV0dXJuIHRoZSB0b2tlbi1tZXRhZGF0YSBVUkkgZm9yIHRoZSBnaXZlbiB0b2tlbi4KCiAgICAgICAgICAgIEZvciBhIHJlZmVyZW5jZSBpbXBsZW1lbnRhdGlvbiwgZHluYW1pYy12aWV3cyBzZWVtIHRvIGJlIHRoZQogICAgICAgICAgICBtb3N0IGZsZXhpYmxlIGNob2ljZS4KICAgICAgICAgICAgIiIiCiAgICAgICAgICAgIHNwLnNldF90eXBlKHRvaywgc3AuVE5hdCkKICAgICAgICAgICAgc3AucmVzdWx0KHNlbGYuZGF0YS50b2tlbl9tZXRhZGF0YVt0b2tdKQoKICAgICAgICBzZWxmLnRva2VuX21ldGFkYXRhID0gc3Aub2ZmY2hhaW5fdmlldyhwdXJlID0gVHJ1ZSwgZG9jID0gIkdldCBUb2tlbiBNZXRhZGF0YSIpKHRva2VuX21ldGFkYXRhKQoKICAgIGRlZiBtYWtlX21ldGFkYXRhKHN5bWJvbCwgbmFtZSwgZGVjaW1hbHMpOgogICAgICAgICJIZWxwZXIgZnVuY3Rpb24gdG8gYnVpbGQgbWV0YWRhdGEgSlNPTiBieXRlcyB2YWx1ZXMuIgogICAgICAgIHJldHVybiAoc3AubWFwKGwgPSB7CiAgICAgICAgICAgICMgUmVtZW1iZXIgdGhhdCBtaWNoZWxzb24gd2FudHMgbWFwIGFscmVhZHkgaW4gb3JkZXJlZAogICAgICAgICAgICAiZGVjaW1hbHMiIDogc3AudXRpbHMuYnl0ZXNfb2Zfc3RyaW5nKCIlZCIgJSBkZWNpbWFscyksCiAgICAgICAgICAgICJuYW1lIiA6IHNwLnV0aWxzLmJ5dGVzX29mX3N0cmluZyhuYW1lKSwKICAgICAgICAgICAgInN5bWJvbCIgOiBzcC51dGlscy5ieXRlc19vZl9zdHJpbmcoc3ltYm9sKQogICAgICAgIH0pKQoKCmNsYXNzIEZBMihGQTJfY2hhbmdlX21ldGFkYXRhLCBGQTJfdG9rZW5fbWV0YWRhdGEsIEZBMl9taW50LCBGQTJfYWRtaW5pc3RyYXRvciwgRkEyX3BhdXNlLCBGQTJfY29yZSk6CgogICAgQHNwLm9mZmNoYWluX3ZpZXcocHVyZSA9IFRydWUpCiAgICBkZWYgY291bnRfdG9rZW5zKHNlbGYpOgogICAgICAgICIiIkdldCBob3cgbWFueSB0b2tlbnMgYXJlIGluIHRoaXMgRkEyIGNvbnRyYWN0LgogICAgICAgICIiIgogICAgICAgIHNwLnJlc3VsdChzZWxmLnRva2VuX2lkX3NldC5jYXJkaW5hbChzZWxmLmRhdGEuYWxsX3Rva2VucykpCgogICAgQHNwLm9mZmNoYWluX3ZpZXcocHVyZSA9IFRydWUpCiAgICBkZWYgZG9lc190b2tlbl9leGlzdChzZWxmLCB0b2spOgogICAgICAgICJBc2sgd2hldGhlciBhIHRva2VuIElEIGlzIGV4aXN0cy4iCiAgICAgICAgc3Auc2V0X3R5cGUodG9rLCBzcC5UTmF0KQogICAgICAgIHNwLnJlc3VsdChzZWxmLmRhdGEudG9rZW5fbWV0YWRhdGEuY29udGFpbnModG9rKSkKCiAgICBAc3Aub2ZmY2hhaW5fdmlldyhwdXJlID0gVHJ1ZSkKICAgIGRlZiBhbGxfdG9rZW5zKHNlbGYpOgogICAgICAgIGlmIHNlbGYuY29uZmlnLmFzc3VtZV9jb25zZWN1dGl2ZV90b2tlbl9pZHM6CiAgICAgICAgICAgIHNwLnJlc3VsdChzcC5yYW5nZSgwLCBzZWxmLmRhdGEuYWxsX3Rva2VucykpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc3AucmVzdWx0KHNlbGYuZGF0YS5hbGxfdG9rZW5zLmVsZW1lbnRzKCkpCgogICAgQHNwLm9mZmNoYWluX3ZpZXcocHVyZSA9IFRydWUpCiAgICBkZWYgdG90YWxfc3VwcGx5KHNlbGYsIHRvayk6CiAgICAgICAgaWYgc2VsZi5jb25maWcuc3RvcmVfdG90YWxfc3VwcGx5OgogICAgICAgICAgICBzcC5yZXN1bHQoc2VsZi5kYXRhLnRvdGFsX3N1cHBseVt0b2tdKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNwLnNldF90eXBlKHRvaywgc3AuVE5hdCkKICAgICAgICAgICAgc3AucmVzdWx0KCJ0b3RhbC1zdXBwbHkgbm90IHN1cHBvcnRlZCIpCgogICAgQHNwLm9mZmNoYWluX3ZpZXcocHVyZSA9IFRydWUpCiAgICBkZWYgaXNfb3BlcmF0b3Ioc2VsZiwgcXVlcnkpOgogICAgICAgIHNwLnNldF90eXBlKHF1ZXJ5LAogICAgICAgICAgICAgICAgICAgIHNwLlRSZWNvcmQodG9rZW5faWQgPSBzcC5UTmF0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3duZXIgPSBzcC5UQWRkcmVzcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wZXJhdG9yID0gc3AuVEFkZHJlc3MpLmxheW91dCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoIm93bmVyIiwgKCJvcGVyYXRvciIsICJ0b2tlbl9pZCIpKSkpCiAgICAgICAgc3AucmVzdWx0KAogICAgICAgICAgICBzZWxmLm9wZXJhdG9yX3NldC5pc19tZW1iZXIoc2VsZi5kYXRhLm9wZXJhdG9ycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHF1ZXJ5Lm93bmVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcXVlcnkub3BlcmF0b3IsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBxdWVyeS50b2tlbl9pZCkKICAgICAgICApCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGNvbmZpZywgbWV0YWRhdGEsIGFkbWluKToKICAgICAgICAjIExldCdzIHNob3cgb2ZmIHNvbWUgbWV0YS1wcm9ncmFtbWluZzoKICAgICAgICBpZiBjb25maWcuYXNzdW1lX2NvbnNlY3V0aXZlX3Rva2VuX2lkczoKICAgICAgICAgICAgc2VsZi5hbGxfdG9rZW5zLmRvYyA9ICIiIgogICAgICAgICAgICBUaGlzIHZpZXcgaXMgc3BlY2lmaWVkIChidXQgb3B0aW9uYWwpIGluIHRoZSBzdGFuZGFyZC4KCiAgICAgICAgICAgIFRoaXMgY29udHJhY3QgaXMgYnVpbHQgd2l0aCBhc3N1bWVfY29uc2VjdXRpdmVfdG9rZW5faWRzID0KICAgICAgICAgICAgVHJ1ZSwgc28gd2UgcmV0dXJuIGEgbGlzdCBjb25zdHJ1Y3RlZCBmcm9tIHRoZSBudW1iZXIgb2YgdG9rZW5zLgogICAgICAgICAgICAiIiIKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLmFsbF90b2tlbnMuZG9jID0gIiIiCiAgICAgICAgICAgIFRoaXMgdmlldyBpcyBzcGVjaWZpZWQgKGJ1dCBvcHRpb25hbCkgaW4gdGhlIHN0YW5kYXJkLgoKICAgICAgICAgICAgVGhpcyBjb250cmFjdCBpcyBidWlsdCB3aXRoIGFzc3VtZV9jb25zZWN1dGl2ZV90b2tlbl9pZHMgPQogICAgICAgICAgICBGYWxzZSwgc28gd2UgY29udmVydCB0aGUgc2V0IG9mIHRva2VucyBmcm9tIHRoZSBzdG9yYWdlIHRvIGEgbGlzdAogICAgICAgICAgICB0byBmaXQgdGhlIGV4cGVjdGVkIHR5cGUgb2YgVFpJUC0xNi4KICAgICAgICAgICAgIiIiCiAgICAgICAgbGlzdF9vZl92aWV3cyA9IFsKICAgICAgICAgICAgc2VsZi5nZXRfYmFsYW5jZQogICAgICAgICAgICAsIHNlbGYuZG9lc190b2tlbl9leGlzdAogICAgICAgICAgICAsIHNlbGYuY291bnRfdG9rZW5zCiAgICAgICAgICAgICwgc2VsZi5hbGxfdG9rZW5zCiAgICAgICAgICAgICwgc2VsZi5pc19vcGVyYXRvcgogICAgICAgIF0KCiAgICAgICAgaWYgY29uZmlnLnN0b3JlX3RvdGFsX3N1cHBseToKICAgICAgICAgICAgbGlzdF9vZl92aWV3cyA9IGxpc3Rfb2Zfdmlld3MgKyBbc2VsZi50b3RhbF9zdXBwbHldCiAgICAgICAgaWYgY29uZmlnLnVzZV90b2tlbl9tZXRhZGF0YV9vZmZjaGFpbl92aWV3OgogICAgICAgICAgICBzZWxmLnNldF90b2tlbl9tZXRhZGF0YV92aWV3KCkKICAgICAgICAgICAgbGlzdF9vZl92aWV3cyA9IGxpc3Rfb2Zfdmlld3MgKyBbc2VsZi50b2tlbl9tZXRhZGF0YV0KCiAgICAgICAgbWV0YWRhdGFfYmFzZSA9IHsKICAgICAgICAgICAgInZlcnNpb24iOiBjb25maWcubmFtZSAjIHdpbGwgYmUgY2hhbmdlZCBpZiB1c2luZyBmYXRvby4KICAgICAgICAgICAgLCAiZGVzY3JpcHRpb24iIDogKAogICAgICAgICAgICAgICAgIlRoaXMgaXMgYSBkaWRhY3RpYyByZWZlcmVuY2UgaW1wbGVtZW50YXRpb24gb2YgRkEyLCIKICAgICAgICAgICAgICAgICsgIiBhLmsuYS4gVFpJUC0wMTIsIHVzaW5nIFNtYXJ0UHkuXG5cbiIKICAgICAgICAgICAgICAgICsgIlRoaXMgcGFydGljdWxhciBjb250cmFjdCB1c2VzIHRoZSBjb25maWd1cmF0aW9uIG5hbWVkOiAiCiAgICAgICAgICAgICAgICArIGNvbmZpZy5uYW1lICsgIi4iCiAgICAgICAgICAgICkKICAgICAgICAgICAgLCAiaW50ZXJmYWNlcyI6IFsiVFpJUC0wMTIiLCAiVFpJUC0wMTYiXQogICAgICAgICAgICAsICJhdXRob3JzIjogWwogICAgICAgICAgICAgICAgIlNlYiBNb25kZXQgPGh0dHBzOi8vc2ViLm1vbmRldC5vcmc+IgogICAgICAgICAgICBdCiAgICAgICAgICAgICwgImhvbWVwYWdlIjogImh0dHBzOi8vZ2l0bGFiLmNvbS9zbW9uZGV0L2ZhMi1zbWFydHB5IgogICAgICAgICAgICAsICJ2aWV3cyI6IGxpc3Rfb2Zfdmlld3MKICAgICAgICAgICAgLCAic291cmNlIjogewogICAgICAgICAgICAgICAgInRvb2xzIjogWyJTbWFydFB5Il0KICAgICAgICAgICAgICAgICwgImxvY2F0aW9uIjogImh0dHBzOi8vZ2l0bGFiLmNvbS9zbW9uZGV0L2ZhMi1zbWFydHB5LmdpdCIKICAgICAgICAgICAgfQogICAgICAgICAgICAsICJwZXJtaXNzaW9ucyI6IHsKICAgICAgICAgICAgICAgICJvcGVyYXRvciI6CiAgICAgICAgICAgICAgICAib3duZXItb3Itb3BlcmF0b3ItdHJhbnNmZXIiIGlmIGNvbmZpZy5zdXBwb3J0X29wZXJhdG9yIGVsc2UgIm93bmVyLXRyYW5zZmVyIgogICAgICAgICAgICAgICAgLCAicmVjZWl2ZXIiOiAib3duZXItbm8taG9vayIKICAgICAgICAgICAgICAgICwgInNlbmRlciI6ICJvd25lci1uby1ob29rIgogICAgICAgICAgICB9CiAgICAgICAgICAgICwgImZhMi1zbWFydHB5IjogewogICAgICAgICAgICAgICAgImNvbmZpZ3VyYXRpb24iIDoKICAgICAgICAgICAgICAgIGRpY3QoWyhrLCBnZXRhdHRyKGNvbmZpZywgaykpIGZvciBrIGluIGRpcihjb25maWcpIGlmICJfXyIgbm90IGluIGsgYW5kIGsgIT0gJ215X21hcCddKQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHNlbGYuaW5pdF9tZXRhZGF0YSgibWV0YWRhdGFfYmFzZSIsIG1ldGFkYXRhX2Jhc2UpCiAgICAgICAgRkEyX2NvcmUuX19pbml0X18oc2VsZiwgY29uZmlnLCBtZXRhZGF0YSwgcGF1c2VkID0gRmFsc2UsIGFkbWluaXN0cmF0b3IgPSBhZG1pbikKCgoKYmF0Y2hfbWludF90eXBlID0gc3AuVFJlY29yZCgKICAgIG1ldGFkYXRhX2xpbmtzID0gc3AuVExpc3Qoc3AuVEJ5dGVzKSwKICAgIGZpcnN0X3Rva2VuX2lkID0gdG9rZW5faWRfdHlwZSwKICAgIGFkZHJlc3MgPSBzcC5UQWRkcmVzcwogICAgKQoKYnVybl90eXBlID0gc3AuVExpc3QoCiAgICBzcC5UUmVjb3JkKAogICAgICAgIHRva2VuX2lkID0gc3AuVE5hdCwKICAgICAgICBvd25lciA9IHNwLlRBZGRyZXNzCiAgICApCikKCmNsYXNzIEJhdGNoX05GVChGQTIpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGNvbmZpZywgbWV0YWRhdGEsIGFkbWluKToKICAgICAgICBGQTIuX19pbml0X18oc2VsZiwgY29uZmlnLCBtZXRhZGF0YSwgYWRtaW4pCgogICAgQHNwLmVudHJ5X3BvaW50CiAgICBkZWYgYmF0Y2hfbWludChzZWxmLCBwYXJhbXMpOgogICAgICAgIHNwLnNldF90eXBlKHBhcmFtcywgYmF0Y2hfbWludF90eXBlKQogICAgICAgIHNwLnZlcmlmeSgKICAgICAgICAgICAgc2VsZi5jb25maWcubm9uX2Z1bmdpYmxlICYgc2VsZi5jb25maWcuYXNzdW1lX2NvbnNlY3V0aXZlX3Rva2VuX2lkcyAmIChzZWxmLmNvbmZpZy5zaW5nbGVfYXNzZXQgPT0gRmFsc2UpLAogICAgICAgICAgICBtZXNzYWdlID0gIldyb25nIENvbmZpZzogYmF0Y2hfbWludCByZXF1aXJlcyAnbm9uX2Z1bmdpYmxlJywgJ2NvbnNlY3V0aXZlX3Rva2VuX2lkcycgYW5kICdtdWx0aXBsZV9hc3NldCciCiAgICAgICAgICAgICkKICAgICAgICBzcC52ZXJpZnkoc2VsZi5pc19hZG1pbmlzdHJhdG9yKHNwLnNlbmRlciksIG1lc3NhZ2UgPSBzZWxmLmVycm9yX21lc3NhZ2Uubm90X2FkbWluKCkpCiAgICAgICAgc3AudmVyaWZ5KHNlbGYuZGF0YS5hbGxfdG9rZW5zID09IHBhcmFtcy5maXJzdF90b2tlbl9pZCwKICAgICAgICAgICAgbWVzc2FnZSA9ICJUaGUgZmlyc3QgdG9rZW5faWQgaGFzIHRvIHJlc3BlY3QgdGhlIGNvbnNlY3V0aXZlbmVzcyIKICAgICAgICApCiAgICAgICAgYW1vdW50ID0gMQogICAgICAgIHNwLmZvciBtZXRhZGF0YSBpbiBwYXJhbXMubWV0YWRhdGFfbGlua3M6CiAgICAgICAgICAgIHRva2VuX2lkID0gc2VsZi5kYXRhLmFsbF90b2tlbnMKICAgICAgICAgICAgdXNlciA9IHNlbGYubGVkZ2VyX2tleS5tYWtlKHBhcmFtcy5hZGRyZXNzLCB0b2tlbl9pZCkKICAgICAgICAgICAgc2VsZi5kYXRhLmxlZGdlclt1c2VyXSA9IExlZGdlcl92YWx1ZS5tYWtlKGFtb3VudCkKICAgICAgICAgICAgc2VsZi5kYXRhLnRva2VuX21ldGFkYXRhW3Rva2VuX2lkXSA9IHNwLnJlY29yZCgKICAgICAgICAgICAgICAgIHRva2VuX2lkICAgID0gdG9rZW5faWQsCiAgICAgICAgICAgICAgICB0b2tlbl9pbmZvICA9IHsiIjogbWV0YWRhdGF9CiAgICAgICAgICAgICkKICAgICAgICAgICAgaWYgc2VsZi5jb25maWcuc3RvcmVfdG90YWxfc3VwcGx5OgogICAgICAgICAgICAgICAgc2VsZi5kYXRhLnRvdGFsX3N1cHBseVt0b2tlbl9pZF0gPSBhbW91bnQKICAgICAgICAgICAgc2VsZi50b2tlbl9pZF9zZXQuYWRkKHNlbGYuZGF0YS5hbGxfdG9rZW5zLCB0b2tlbl9pZCkKCiAgICBAc3AuZW50cnlfcG9pbnQKICAgIGRlZiBidXJuKHNlbGYsIHBhcmFtcyk6CiAgICAgICAgc3Auc2V0X3R5cGUocGFyYW1zLCBidXJuX3R5cGUpCiAgICAgICAgc3AudmVyaWZ5KAogICAgICAgICAgICBzZWxmLmNvbmZpZy5ub25fZnVuZ2libGUgJiAoc2VsZi5jb25maWcuc2luZ2xlX2Fzc2V0ID09IEZhbHNlKSwKICAgICAgICAgICAgbWVzc2FnZSA9ICJXcm9uZyBDb25maWc6IGJ1cm4gcmVxdWlyZXMgJ25vbl9mdW5naWJsZScgYW5kICdtdWx0aXBsZV9hc3NldCciCiAgICAgICAgICAgICkKICAgICAgICBzcC52ZXJpZnkoc2VsZi5pc19hZG1pbmlzdHJhdG9yKHNwLnNlbmRlciksIG1lc3NhZ2UgPSBzZWxmLmVycm9yX21lc3NhZ2Uubm90X2FkbWluKCkpCiAgICAgICAgd2l0aCBzcC5mb3JfKCJidXJuIiwgcGFyYW1zKSBhcyBidXJuOgogICAgICAgICAgICBzcC52ZXJpZnkoCiAgICAgICAgICAgICAgICBzZWxmLmRhdGEudG9rZW5fbWV0YWRhdGEuY29udGFpbnMoYnVybi50b2tlbl9pZCksCiAgICAgICAgICAgICAgICBtZXNzYWdlID0gc2VsZi5lcnJvcl9tZXNzYWdlLnRva2VuX3VuZGVmaW5lZCgpCiAgICAgICAgICAgICkKICAgICAgICAgICAgdXNlciA9IHNlbGYubGVkZ2VyX2tleS5tYWtlKGJ1cm4ub3duZXIsIGJ1cm4udG9rZW5faWQpCiAgICAgICAgICAgIHNwLnZlcmlmeShzZWxmLmRhdGEubGVkZ2VyW3VzZXJdLmJhbGFuY2UgPT0gMSwgIldST05HX05GVF9PV05FUiIpCiAgICAgICAgICAgICMgQnVybiB0aGUgdG9rZW4KICAgICAgICAgICAgZGVsIHNlbGYuZGF0YS5sZWRnZXJbdXNlcl0KICAgICAgICAgICAgZGVsIHNlbGYuZGF0YS50b2tlbl9tZXRhZGF0YVtidXJuLnRva2VuX2lkXQogICAgICAgICAgICBpZiBzZWxmLmNvbmZpZy5zdG9yZV90b3RhbF9zdXBwbHk6CiAgICAgICAgICAgICAgICBkZWwgc2VsZi5kYXRhLnRvdGFsX3N1cHBseVtidXJuLnRva2VuX2lkXQoKCiAgICBAc3Aub25jaGFpbl92aWV3KG5hbWUgPSAiY291bnRfdG9rZW5zIikKICAgIGRlZiBjb3VudF90b2tlbnMoc2VsZik6CiAgICAgICAgIiIiR2V0IGhvdyBtYW55IHRva2VucyBhcmUgaW4gdGhpcyBGQTIgY29udHJhY3QuCiAgICAgICAgIiIiCiAgICAgICAgc3AucmVzdWx0KHNlbGYudG9rZW5faWRfc2V0LmNhcmRpbmFsKHNlbGYuZGF0YS5hbGxfdG9rZW5zKSkKCiAgICBAc3Aub25jaGFpbl92aWV3KG5hbWUgPSAiZG9lc190b2tlbl9leGlzdCIpCiAgICBkZWYgZG9lc190b2tlbl9leGlzdChzZWxmLCB0b2spOgogICAgICAgICJBc2sgd2hldGhlciBhIHRva2VuIElEIGlzIGV4aXN0cy4iCiAgICAgICAgc3Auc2V0X3R5cGUodG9rLCBzcC5UTmF0KQogICAgICAgIHNwLnJlc3VsdChzZWxmLmRhdGEudG9rZW5fbWV0YWRhdGEuY29udGFpbnModG9rKSkKCiAgICBAc3Aub25jaGFpbl92aWV3KG5hbWUgPSAiYWxsX3Rva2VucyIpCiAgICBkZWYgYWxsX3Rva2VucyhzZWxmKToKICAgICAgICBpZiBzZWxmLmNvbmZpZy5hc3N1bWVfY29uc2VjdXRpdmVfdG9rZW5faWRzOgogICAgICAgICAgICBzcC5yZXN1bHQoc3AucmFuZ2UoMCwgc2VsZi5kYXRhLmFsbF90b2tlbnMpKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNwLnJlc3VsdChzZWxmLmRhdGEuYWxsX3Rva2Vucy5lbGVtZW50cygpKQoKICAgIEBzcC5vbmNoYWluX3ZpZXcobmFtZSA9ICJ0b3RhbF9zdXBwbHkiKQogICAgZGVmIHRvdGFsX3N1cHBseShzZWxmLCB0b2spOgogICAgICAgIHNwLnNldF90eXBlKHRvaywgc3AuVE5hdCkKICAgICAgICBzcC52ZXJpZnkoc2VsZi5jb25maWcuc3RvcmVfdG90YWxfc3VwcGx5LCAiVE9ETyIpCiAgICAgICAgc3AucmVzdWx0KHNlbGYuZGF0YS50b3RhbF9zdXBwbHlbdG9rXSkKCiAgICBAc3Aub25jaGFpbl92aWV3KG5hbWUgPSAiaXNfb3BlcmF0b3IiKQogICAgZGVmIGlzX29wZXJhdG9yKHNlbGYsIHF1ZXJ5KToKICAgICAgICBzcC5zZXRfdHlwZShxdWVyeSwKICAgICAgICAgICAgICAgICAgICBzcC5UUmVjb3JkKHRva2VuX2lkID0gc3AuVE5hdCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG93bmVyID0gc3AuVEFkZHJlc3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcGVyYXRvciA9IHNwLlRBZGRyZXNzKS5sYXlvdXQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKCJvd25lciIsICgib3BlcmF0b3IiLCAidG9rZW5faWQiKSkpKQogICAgICAgIHNwLnJlc3VsdCgKICAgICAgICAgICAgc2VsZi5vcGVyYXRvcl9zZXQuaXNfbWVtYmVyKHNlbGYuZGF0YS5vcGVyYXRvcnMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBxdWVyeS5vd25lciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHF1ZXJ5Lm9wZXJhdG9yLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcXVlcnkudG9rZW5faWQpCiAgICAgICAgKQoKICAgIEBzcC5vbmNoYWluX3ZpZXcobmFtZSA9ICJnZXRfYmFsYW5jZSIpCiAgICBkZWYgZ2V0X2JhbGFuY2Uoc2VsZiwgcmVxKToKICAgICAgICAiIiJUaGlzIGlzIHRoZSBgZ2V0X2JhbGFuY2VgIHZpZXcgZGVmaW5lZCBpbiBUWklQLTEyLiIiIgogICAgICAgIHNwLnNldF90eXBlKAogICAgICAgICAgICByZXEsIHNwLlRSZWNvcmQoCiAgICAgICAgICAgICAgICBvd25lciA9IHNwLlRBZGRyZXNzLAogICAgICAgICAgICAgICAgdG9rZW5faWQgPSBzcC5UTmF0CiAgICAgICAgICAgICkubGF5b3V0KCgib3duZXIiLCAidG9rZW5faWQiKSkpCiAgICAgICAgdXNlciA9IHNlbGYubGVkZ2VyX2tleS5tYWtlKHJlcS5vd25lciwgcmVxLnRva2VuX2lkKQogICAgICAgIHNwLnZlcmlmeShzZWxmLmRhdGEudG9rZW5fbWV0YWRhdGEuY29udGFpbnMocmVxLnRva2VuX2lkKSwgbWVzc2FnZSA9IHNlbGYuZXJyb3JfbWVzc2FnZS50b2tlbl91bmRlZmluZWQoKSkKICAgICAgICBzcC5yZXN1bHQoc2VsZi5kYXRhLmxlZGdlclt1c2VyXS5iYWxhbmNlKQoKICAgIEBzcC5vbmNoYWluX3ZpZXcobmFtZSA9ICJ0b2tfbWV0YWRhdGEiKQogICAgZGVmIHRva19tZXRhZGF0YShzZWxmLCB0b2spOgogICAgICAgICIiIlJldHVybnMgdGhlIHRva2VuLW1ldGFkYXRhIFVSSSBmb3IgdGhlIGdpdmVuIHRva2VuLiIiIgogICAgICAgIHNwLnNldF90eXBlKHRvaywgc3AuVE5hdCkKICAgICAgICBzcC5yZXN1bHQoc2VsZi5kYXRhLnRva2VuX21ldGFkYXRhW3Rva10pCgoKCiMjICMjIyBHZW5lcmF0aW9uIG9mIFRlc3QgU2NlbmFyaW9zCiMjCiMjIFRlc3RzIGFyZSBhbHNvIHBhcmFtZXRyaXplZCBieSB0aGUgYEZBMl9jb25maWdgIG9iamVjdC4KIyMgVGhlIGJlc3Qgd2F5IHRvIHZpc3VhbGl6ZSB0aGVtIGlzIHRvIHVzZSB0aGUgb25saW5lIElERQojIyAoPGh0dHBzOi8vd3d3LnNtYXJ0cHkuaW8vaWRlLz4pLgpkZWYgYWRkX3Rlc3QoY29uZmlnLCBpc19kZWZhdWx0ID0gVHJ1ZSk6CiAgICBAc3AuYWRkX3Rlc3QobmFtZSA9IGNvbmZpZy5uYW1lLCBpc19kZWZhdWx0ID0gaXNfZGVmYXVsdCkKICAgIGRlZiB0ZXN0KCk6CiAgICAgICAgc2NlbmFyaW8gPSBzcC50ZXN0X3NjZW5hcmlvKCkKCiAgICAgICAgIyMjIElOSVRJQUwgU1RPUkFHRQogICAgICAgICMjIFB1dCB0aGUgcmVhbCBpbml0aWFsIGNvbnRyYWN0IHBhcmFtZXRlcnMgaGVyZSwgdGhlIGNvbnRyYWN0IHdpbGwgYmUgZGVwbG95ZWQgd2l0aCB0aGUgZm9sbG93aW5nIHBhcmFtZXRlcnMKICAgICAgICBhZG1pbiA9IHNwLmFkZHJlc3MoIktUMUFrZUR4UkgzTW95NE5QZHY1RllSRGdReE1ZRUhFcG5WciIpCiAgICAgICAgbWV0YWRhdGFfdXJsID0gImlwZnM6Ly9RbVlHMmhXaXVrdWMyYUQzSjlRUUpMZ1RqVE5hcktpSmdEWWJrTXRqQjFndG5YIgoKICAgICAgICAjIyMgT05MSU5FIERFUExPWU1FTlQgVEFSR0VUCiAgICAgICAgc2NlbmFyaW8uaDEoIk9OTElORSBEZXBsb3ltZW50IHRhcmdldCIpCiAgICAgICAgYzEgPSBCYXRjaF9ORlQoY29uZmlnID0gY29uZmlnLAogICAgICAgICAgICAgICAgIG1ldGFkYXRhID0gc3AudXRpbHMubWV0YWRhdGFfb2ZfdXJsKG1ldGFkYXRhX3VybCksCiAgICAgICAgICAgICAgICAgYWRtaW4gPSBhZG1pbikKICAgICAgICBzY2VuYXJpbyArPSBjMQoKICAgICAgICAjIyMgQ0xJIERFUExPWU1FTlQgVEFSR0VUCiAgICAgICAgc3AuYWRkX2NvbXBpbGF0aW9uX3RhcmdldCgKICAgICAgICAgICAgIkJhdGNoX05GVCIsCiAgICAgICAgICAgIEJhdGNoX05GVChjb25maWcgPSBjb25maWcsCiAgICAgICAgICAgICAgICAgbWV0YWRhdGEgPSBzcC51dGlscy5tZXRhZGF0YV9vZl91cmwobWV0YWRhdGFfdXJsKSwKICAgICAgICAgICAgICAgICBhZG1pbiA9IGFkbWluKQogICAgICAgICkKCiAgICAgICAgIyMjIFRFU1QgU0NFTkFSSU8KICAgICAgICBzY2VuYXJpby5oMSgiRkEyIENvbnRyYWN0IE5hbWU6ICIgKyBjb25maWcubmFtZSkKICAgICAgICBzY2VuYXJpby50YWJsZV9vZl9jb250ZW50cygpCiAgICAgICAgYWxpY2UgPSBzcC50ZXN0X2FjY291bnQoIkFsaWNlIikKCiAgICAgICAgc2NlbmFyaW8ucCgiQWRtaW4gbWludHMgNCBORlRzIikKICAgICAgICBzY2VuYXJpbyArPSBjMS5iYXRjaF9taW50KHNwLnJlY29yZCgKICAgICAgICAgICAgYWRkcmVzcyA9IGFkbWluLAogICAgICAgICAgICBmaXJzdF90b2tlbl9pZCA9IDAsCiAgICAgICAgICAgIG1ldGFkYXRhX2xpbmtzID0gWwogICAgICAgICAgICAgICAgc3AuYnl0ZXMoIjB4MDUwMTAwMDAwMDM1Njk3MDY2NzMzYTJmMmY1MTZkNWEzNjU4NDc2MjY5NWE0ZDc3NjY0NDU0MzI1MDY2NDM2ZTcxNzQ3NDYyNDI2ZTU2NGQ0YTcyNzQ3MzM5NzY3MDYzNjg2NzU3NTI1MTU0NGIzMzMzNzc2MiIpLAogICAgICAgICAgICAgICAgc3AuYnl0ZXMoIjB4MDUwMjAwMDAwMDM1Njk3MDY2NzMzYTJmMmY1MTZkNWEzNjU4NDc2MjY5NWE0ZDc3NjY0NDU0MzI1MDY2NDM2ZTcxNzQ3NDYyNDI2ZTU2NGQ0YTcyNzQ3MzM5NzY3MDYzNjg2NzU3NTI1MTU0NGIzMzMzNzc2MiIpLAogICAgICAgICAgICAgICAgc3AuYnl0ZXMoIjB4MDUwMzAwMDAwMDM1Njk3MDY2NzMzYTJmMmY1MTZkNWEzNjU4NDc2MjY5NWE0ZDc3NjY0NDU0MzI1MDY2NDM2ZTcxNzQ3NDYyNDI2ZTU2NGQ0YTcyNzQ3MzM5NzY3MDYzNjg2NzU3NTI1MTU0NGIzMzMzNzc2MiIpLAogICAgICAgICAgICAgICAgc3AuYnl0ZXMoIjB4MDUwNDAwMDAwMDM1Njk3MDY2NzMzYTJmMmY1MTZkNWEzNjU4NDc2MjY5NWE0ZDc3NjY0NDU0MzI1MDY2NDM2ZTcxNzQ3NDYyNDI2ZTU2NGQ0YTcyNzQ3MzM5NzY3MDYzNjg2NzU3NTI1MTU0NGIzMzMzNzc2MiIpCiAgICAgICAgICAgICAgICBdCiAgICAgICAgKSkucnVuKHNlbmRlciA9IGFkbWluKQoKICAgICAgICBzY2VuYXJpby5wKCJUaGUgbWludCBmYWlscyB3aGVuIHRoZSBmaXJzdF90b2tlbl9pZCBhbHJlYWR5IGV4aXN0cyIpCiAgICAgICAgc2NlbmFyaW8gKz0gYzEuYmF0Y2hfbWludChzcC5yZWNvcmQoYWRkcmVzcyA9IGFkbWluLCBmaXJzdF90b2tlbl9pZCA9IDMsIG1ldGFkYXRhX2xpbmtzID0gW3NwLmJ5dGVzKCIweDA1MDEiKV0pKS5ydW4oc2VuZGVyID0gYWRtaW4sIHZhbGlkID0gRmFsc2UpCiAgICAgICAgc2NlbmFyaW8ucCgiVGhlIG1pbnQgZmFpbHMgd2hlbiB0aGUgZmlyc3RfdG9rZW5faWQgY29uc2VjdXRpdmVuZXNzIGlzIG5vdCByZXNwZWN0ZWQiKQogICAgICAgIHNjZW5hcmlvICs9IGMxLmJhdGNoX21pbnQoc3AucmVjb3JkKGFkZHJlc3MgPSBhZG1pbiwgZmlyc3RfdG9rZW5faWQgPSA1LCBtZXRhZGF0YV9saW5rcyA9IFtzcC5ieXRlcygiMHgwNTAxIildKSkucnVuKHNlbmRlciA9IGFkbWluLCB2YWxpZCA9IEZhbHNlKQogICAgICAgIHNjZW5hcmlvLnAoIlRoZSBtaW50IGlzIHN1Y2Nlc3NmdWxsIHdoZW4gdGhlIGZpcnN0X3Rva2VuX2lkIGNvbnNlY3V0aXZlbmVzcyBpcyByZXNwZWN0ZWQiKQogICAgICAgIHNjZW5hcmlvICs9IGMxLmJhdGNoX21pbnQoc3AucmVjb3JkKAogICAgICAgICAgICBhZGRyZXNzID0gYWRtaW4sCiAgICAgICAgICAgIGZpcnN0X3Rva2VuX2lkID0gNCwKICAgICAgICAgICAgbWV0YWRhdGFfbGlua3MgPSBbCiAgICAgICAgICAgICAgICBzcC5ieXRlcygiMHgwNTAxMDAwMDAwMzU2OTcwNjY3MzNhMmYyZjUxNmQ1YTM2NTg0NzYyNjk1YTRkNzc2NjQ0NTQzMjUwNjY0MzZlNzE3NDc0NjI0MjZlNTY0ZDRhNzI3NDczMzk3NjcwNjM2ODY3NTc1MjUxNTQ0YjMzMzM3NzYyIikKICAgICAgICAgICAgICAgIF0KICAgICAgICApKS5ydW4oc2VuZGVyID0gYWRtaW4pCiAgICAgICAgc2NlbmFyaW8gKz0gYzEudHJhbnNmZXIoWwogICAgICAgICAgICBzcC5yZWNvcmQoCiAgICAgICAgICAgICAgICBmcm9tXyA9IGFkbWluLAogICAgICAgICAgICAgICAgdHhzID0gWwogICAgICAgICAgICAgICAgICAgIHNwLnJlY29yZCgKICAgICAgICAgICAgICAgICAgICAgICAgdG9fID0gYWxpY2UuYWRkcmVzcywKICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW5faWQgPSAyLAogICAgICAgICAgICAgICAgICAgICAgICBhbW91bnQgPSAxCiAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIF0KICAgICAgICApLnJ1bihzZW5kZXIgPSBhZG1pbikKCgojIwojIyAjIyBHbG9iYWwgRW52aXJvbm1lbnQgUGFyYW1ldGVycwojIwojIyBUaGUgYnVpbGQgc3lzdGVtIGNvbW11bmljYXRlcyB3aXRoIHRoZSBweXRob24gc2NyaXB0IHRocm91Z2gKIyMgZW52aXJvbm1lbnQgdmFyaWFibGVzLgojIyBUaGUgZnVuY3Rpb24gYGVudmlyb25tZW50X2NvbmZpZ2AgY3JlYXRlcyBhbiBgRkEyX2NvbmZpZ2AgZ2l2ZW4gdGhlCiMjIHByZXNlbmNlIGFuZCB2YWx1ZXMgb2YgYSBmZXcgZW52aXJvbm1lbnQgdmFyaWFibGVzLgpkZWYgZ2xvYmFsX3BhcmFtZXRlcihlbnZfdmFyLCBkZWZhdWx0KToKICAgIHRyeToKICAgICAgICBpZiBvcy5lbnZpcm9uW2Vudl92YXJdID09ICJ0cnVlIiA6CiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgaWYgb3MuZW52aXJvbltlbnZfdmFyXSA9PSAiZmFsc2UiIDoKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgcmV0dXJuIGRlZmF1bHQKICAgIGV4Y2VwdDoKICAgICAgICByZXR1cm4gZGVmYXVsdAoKZGVmIGVudmlyb25tZW50X2NvbmZpZygpOgogICAgcmV0dXJuIEZBMl9jb25maWcoCiAgICAgICAgZGVidWdfbW9kZSA9IGdsb2JhbF9wYXJhbWV0ZXIoImRlYnVnX21vZGUiLCBGYWxzZSksCiAgICAgICAgc2luZ2xlX2Fzc2V0ID0gZ2xvYmFsX3BhcmFtZXRlcigic2luZ2xlX2Fzc2V0IiwgRmFsc2UpLAogICAgICAgIG5vbl9mdW5naWJsZSA9IGdsb2JhbF9wYXJhbWV0ZXIoIm5vbl9mdW5naWJsZSIsIFRydWUpLAogICAgICAgIGFkZF9tdXRlel90cmFuc2ZlciA9IGdsb2JhbF9wYXJhbWV0ZXIoImFkZF9tdXRlel90cmFuc2ZlciIsIEZhbHNlKSwKICAgICAgICByZWFkYWJsZSA9IGdsb2JhbF9wYXJhbWV0ZXIoInJlYWRhYmxlIiwgVHJ1ZSksCiAgICAgICAgZm9yY2VfbGF5b3V0cyA9IGdsb2JhbF9wYXJhbWV0ZXIoImZvcmNlX2xheW91dHMiLCBUcnVlKSwKICAgICAgICBzdXBwb3J0X29wZXJhdG9yID0gZ2xvYmFsX3BhcmFtZXRlcigic3VwcG9ydF9vcGVyYXRvciIsIFRydWUpLAogICAgICAgIGFzc3VtZV9jb25zZWN1dGl2ZV90b2tlbl9pZHMgPQogICAgICAgICAgICBnbG9iYWxfcGFyYW1ldGVyKCJhc3N1bWVfY29uc2VjdXRpdmVfdG9rZW5faWRzIiwgVHJ1ZSksCiAgICAgICAgc3RvcmVfdG90YWxfc3VwcGx5ID0gZ2xvYmFsX3BhcmFtZXRlcigic3RvcmVfdG90YWxfc3VwcGx5IiwgVHJ1ZSksCiAgICAgICAgbGF6eV9lbnRyeV9wb2ludHMgPSBnbG9iYWxfcGFyYW1ldGVyKCJsYXp5X2VudHJ5X3BvaW50cyIsIEZhbHNlKSwKICAgICAgICBhbGxvd19zZWxmX3RyYW5zZmVyID0gZ2xvYmFsX3BhcmFtZXRlcigiYWxsb3dfc2VsZl90cmFuc2ZlciIsIEZhbHNlKSwKICAgICAgICB1c2VfdG9rZW5fbWV0YWRhdGFfb2ZmY2hhaW5fdmlldyA9IGdsb2JhbF9wYXJhbWV0ZXIoInVzZV90b2tlbl9tZXRhZGF0YV9vZmZjaGFpbl92aWV3IiwgVHJ1ZSksCiAgICApCgojIyAjIyBTdGFuZGFyZCDigJxtYWlu4oCdCiMjCiMjIFRoaXMgc3BlY2lmaWMgbWFpbiB1c2VzIHRoZSByZWxhdGl2ZSBuZXcgZmVhdHVyZSBvZiBub24tZGVmYXVsdCB0ZXN0cwojIyBmb3IgdGhlIGJyb3dzZXIgdmVyc2lvbi4KaWYgInRlbXBsYXRlcyIgbm90IGluIF9fbmFtZV9fOgogICAgYWRkX3Rlc3QoZW52aXJvbm1lbnRfY29uZmlnKCkp',
          storageObj: {
            administrator: 'tz1hG1QqTMsd8XPpJkGwRmUeVBdNZSGDCPuQ',
            all_tokens: 0,
            ledger: {},
            metadata: {},
            operators: {},
            paused: false,
            token_metadata: {},
            total_supply: {},
          },
        });

      expect(body).toEqual({
        operation_hash: 'operation_hash',
        contract_address: 'contract_address',
      });
      expect(status).toEqual(201);
    });
  });
});
